<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ·±åº¦è®ºæ–‡ç”ŸæˆåŠ©æ‰‹ (å±‚çº§ä¿®æ­£ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .sidebar { background: white; padding: 25px; border-right: 1px solid #e0e0e0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .output-area { background: white; padding: 40px; min-height: 100vh; overflow-y: auto; position: relative;}
        #logArea { font-size: 0.8rem; background: #212529; color: #00ff9d; padding: 15px; border-radius: 6px; font-family: monospace; height: 150px; overflow-y: auto; margin-top: auto; border: 1px solid #444;}
        
        .chapter-config-item { 
            background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-config-item .label { font-weight: 600; font-size: 0.9rem; color: #495057; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;}
        
        textarea { font-size: 0.85rem !important; resize: vertical; }
        /* é’ˆå¯¹ä¸åŒå±‚çº§æ ‡é¢˜çš„æ¸²æŸ“ä¼˜åŒ– */
        .markdown-body h2 { border-left: 5px solid #0d6efd; padding-left: 10px; margin-top: 40px; color: #2c3e50; font-size: 1.6rem;}
        .markdown-body p { text-align: justify; line-height: 1.8; margin-bottom: 1.2rem; color: #333; }
        .step-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; }

        .control-bar {
            position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100;
            padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

<div class="container-fluid g-0">
    <div class="row g-0">
        <div class="col-md-4">
            <div class="sidebar">
                <h5 class="mb-4 fw-bold text-primary"><i class="bi bi-gear-fill"></i> è®ºæ–‡é…ç½®å·¥ä½œå°</h5>
                <form id="paperForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">1</span>è®ºæ–‡é¢˜ç›®</label>
                        <input type="text" class="form-control" id="paperTitle" placeholder="è¾“å…¥è®ºæ–‡é¢˜ç›®" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span><span class="step-badge">2</span>å®Œæ•´å¤§çº² (è‡ªåŠ¨è¯†åˆ«å±‚çº§)</span>
                            <a href="#" class="text-decoration-none small" onclick="loadDemoOutline()">å¡«å…¥ç¤ºä¾‹</a>
                        </label>
                        <textarea class="form-control" id="outlineRaw" rows="10" placeholder="æ‘˜è¦&#10;1. ç»ªè®º&#10;1.1 ç ”ç©¶èƒŒæ™¯&#10;1.4 ç ”ç©¶å†…å®¹ä¸æ–¹æ³•&#10;1.4.1 ç ”ç©¶å†…å®¹&#10;1.4.2 ç ”ç©¶æ–¹æ³•" required oninput="parseOutline()"></textarea>
                        <div class="form-text text-muted small">ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ« "1.4" ä¸ºçˆ¶æ ‡é¢˜(ä¸å†™å†…å®¹)ï¼Œ"1.4.1" ä¸ºå­å†…å®¹ã€‚</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">3</span>å†™ä½œå­—æ•°åˆ†é…</label>
                        <div id="chapterConfigArea" style="max-height: 250px; overflow-y: auto;">
                            <div class="text-center text-muted small py-3">è¯·è¾“å…¥å¤§çº²...</div>
                        </div>
                        <div class="text-end mt-1">
                            <small class="fw-bold text-primary">æ€»è®¡é¢„ä¼°: <span id="totalWords">0</span> å­—</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">4</span>å‚è€ƒæ–‡çŒ®</label>
                        <textarea class="form-control" id="references" rows="5" placeholder="è¯·ç²˜è´´å‚è€ƒæ–‡çŒ®..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                </form>
                <div id="logArea" class="mt-3">ç­‰å¾…å°±ç»ª...</div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="output-area">
                <div class="control-bar mb-4">
                    <h4 class="m-0 text-dark">ğŸ“„ ç”Ÿæˆç»“æœé¢„è§ˆ</h4>
                    <div id="controlButtons" style="display: none;">
                        <button class="btn btn-warning btn-sm me-2" id="btnPause" onclick="togglePause()">â¸ æš‚åœ</button>
                        <button class="btn btn-danger btn-sm me-2" onclick="stopTask()">â¹ åœæ­¢</button>
                        <button class="btn btn-success btn-sm" onclick="exportToMarkdown()">ğŸ“¥ å¯¼å‡º MD</button>
                    </div>
                </div>
                <div id="resultContent" class="markdown-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <p style="font-size: 1.2rem;">ğŸ’¡ æ™ºèƒ½è¯†åˆ«å¤§çº²å±‚çº§ï¼Œçˆ¶çº§æ ‡é¢˜å°†åªä½œä¸ºç»“æ„å±•ç¤º</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let parsedStructure = []; // å­˜å‚¨ç»“æ„åŒ–å¤§çº²
    let fullMarkdownText = "";
    let currentTaskId = "";
    let isPaused = false;

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c === 'x' ? Math.random() * 16 | 0 : (Math.random() * 16 | 0) & 0x3 | 0x8).toString(16));
    }

    function loadDemoOutline() {
        document.getElementById('outlineRaw').value = `æ‘˜è¦
1. ç»ªè®º
1.1 ç ”ç©¶èƒŒæ™¯
1.2 ç ”ç©¶æ„ä¹‰
1.4 ç ”ç©¶å†…å®¹ä¸æ–¹æ³•
1.4.1 ç ”ç©¶å†…å®¹
1.4.2 ç ”ç©¶æ–¹æ³•
2. ç†è®ºåŸºç¡€
2.1 æ ¸å¿ƒæ¦‚å¿µ
2.2 ç†è®ºæ¡†æ¶
3. ç»“è®º`;
        parseOutline();
    }

    // --- æ ¸å¿ƒï¼šå±‚çº§è§£æç®—æ³• ---
    function parseOutline() {
        const text = document.getElementById('outlineRaw').value;
        // 1. åˆæ­¥æ¸…æ´—ï¼Œå»é™¤ç©ºè¡Œ
        let rawLines = text.split('\n').map(l => l.trim()).filter(l => l);
        
        // 2. æ‘˜è¦å»é‡ï¼šå¦‚æœæœ‰äº†â€œæ‘˜è¦â€ï¼Œå°±è¿‡æ»¤æ‰â€œAbstractâ€
        const hasChineseAbstract = rawLines.some(l => l.includes("æ‘˜è¦"));
        if (hasChineseAbstract) {
            rawLines = rawLines.filter(l => !l.toLowerCase().includes("abstract") && !l.includes("Abstract"));
        }

        // 3. æ„å»ºæ ‘å½¢ç»“æ„é€»è¾‘é¢„åˆ¤
        // æˆ‘ä»¬éœ€è¦è¯†åˆ«æ¯ä¸€è¡Œæ˜¯å¦æ˜¯â€œçˆ¶èŠ‚ç‚¹â€
        // è§„åˆ™ï¼šå¦‚æœ Line A çš„åºå·ï¼ˆå¦‚ 1.4ï¼‰æ˜¯ Line B åºå·ï¼ˆå¦‚ 1.4.1ï¼‰çš„å‰ç¼€ï¼Œåˆ™ A æ˜¯çˆ¶èŠ‚ç‚¹
        
        parsedStructure = [];
        let currentMainGroup = null; // ç”¨äºUIæ˜¾ç¤ºçš„ç»„ï¼ˆå¤§ç« ï¼‰

        // æ­£åˆ™æå–åºå·ï¼šåŒ¹é… "1.", "1.4", "1.4.1" ç­‰
        const numRegex = /^(\d+(\.\d+)*)/; 

        for (let i = 0; i < rawLines.length; i++) {
            const line = rawLines[i];
            
            // æå–å½“å‰è¡Œåºå·
            const matchCurrent = line.match(numRegex);
            const numCurrent = matchCurrent ? matchCurrent[1] : null;
            
            let isParent = false;
            
            // å‘åçœ‹ä¸€è¡Œï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºçˆ¶èŠ‚ç‚¹
            if (i < rawLines.length - 1 && numCurrent) {
                const nextLine = rawLines[i+1];
                const matchNext = nextLine.match(numRegex);
                const numNext = matchNext ? matchNext[1] : null;
                
                // å¦‚æœä¸‹ä¸€è¡Œçš„åºå· ä»¥ å½“å‰è¡Œåºå·+. å¼€å¤´ (ä¾‹å¦‚ 1.4.1 startsWith 1.4.)
                if (numNext && numNext.startsWith(numCurrent + '.')) {
                    isParent = true;
                }
            }

            // åˆ¤æ–­æ˜¯å¦æ˜¯é¡¶çº§ç« èŠ‚ï¼ˆç”¨äºUIåˆ†ç»„æ˜¾ç¤ºå­—æ•°æ§åˆ¶ï¼‰
            // ç®€å•é€»è¾‘ï¼šå¦‚æœæ˜¯ "1." æˆ– "æ‘˜è¦" æˆ– "ç»“è®º"ï¼Œè§†ä¸ºä¸€ä¸ªUIé…ç½®ç»„çš„å¼€å§‹
            const isMainChapter = /^(\d+)(\.|ã€|\s)(?!\d)/.test(line) || ["æ‘˜è¦", "ç»“è®º", "ç»ªè®º"].some(k => line.includes(k)) && !line.includes(".");

            if (isMainChapter) {
                currentMainGroup = { 
                    title: line, 
                    children: [], // åŒ…å«è‡ªå·±å’Œæ‰€æœ‰å­èŠ‚ç‚¹
                    defaultWords: 1000 
                };
                parsedStructure.push(currentMainGroup);
            } else {
                if (!currentMainGroup) {
                    currentMainGroup = { title: "å‰è¨€/å…¶ä»–", children: [], defaultWords: 500 };
                    parsedStructure.push(currentMainGroup);
                }
            }
            
            // å°†è¡Œä¿¡æ¯åŠ å…¥å½“å‰ç»„ï¼Œå¹¶æ ‡è®°æ˜¯å¦ä¸º Parent
            currentMainGroup.children.push({
                text: line,
                isParent: isParent
            });
        }
        
        renderConfigArea();
    }

    function renderConfigArea() {
        const container = document.getElementById('chapterConfigArea');
        container.innerHTML = '';
        let totalWords = 0;

        parsedStructure.forEach((group, index) => {
            // è®¡ç®—è¿™ä¸ªå¤§ç»„é‡Œæœ‰å¤šå°‘ä¸ªâ€œå¶å­èŠ‚ç‚¹â€ï¼ˆå³å®é™…éœ€è¦å†™å­—çš„ç« èŠ‚ï¼‰
            const leafCount = group.children.filter(c => !c.isParent).length;
            
            // æ™ºèƒ½é¢„è®¾å­—æ•°
            let w = 1000;
            if (group.title.includes("æ‘˜è¦")) w = 350;
            else if (group.title.includes("ç»ªè®º")) w = 1500;
            else if (leafCount > 3) w = leafCount * 400; // å¦‚æœå­é¡¹å¤šï¼Œå­—æ•°å¢åŠ 
            
            totalWords += w;

            const div = document.createElement('div');
            div.className = 'chapter-config-item';
            div.innerHTML = `
                <div>
                    <div class="label" title="${group.title}">${group.title}</div>
                    <div class="sub-count">
                        ${group.children.length} ä¸ªæ ‡é¢˜ 
                        <span class="badge bg-secondary" style="font-size:0.6rem">${leafCount} ä¸ªå†™ä½œç‚¹</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <input type="number" class="form-control form-control-sm word-input" 
                           data-idx="${index}" value="${w}" step="50" min="0" onchange="recalcTotal()">
                    <span class="ms-1 small text-muted">å­—</span>
                </div>
            `;
            container.appendChild(div);
        });
        document.getElementById('totalWords').innerText = totalWords;
    }

    function recalcTotal() {
        let total = 0;
        document.querySelectorAll('.word-input').forEach(i => total += parseInt(i.value)||0);
        document.getElementById('totalWords').innerText = total;
    }

    // --- æäº¤é€»è¾‘ï¼šæ„å»ºä»»åŠ¡åˆ—è¡¨ ---
    document.getElementById('paperForm').onsubmit = async (e) => {
        e.preventDefault();
        currentTaskId = generateUUID();
        isPaused = false;
        
        const inputs = document.querySelectorAll('.word-input');
        const flatTasks = [];

        // éå†UIä¸Šçš„å¤§ç»„
        parsedStructure.forEach((group, index) => {
            const totalAssigned = parseInt(inputs[index].value) || 0;
            const leafNodes = group.children.filter(c => !c.isParent);
            const leafCount = leafNodes.length;
            
            // å¹³å‡åˆ†é…å­—æ•°ç»™å¶å­èŠ‚ç‚¹
            const perWord = leafCount > 0 ? Math.floor(totalAssigned / leafCount) : 0;

            // éå†è¯¥ç»„çš„æ‰€æœ‰è¡Œï¼ˆåŒ…æ‹¬çˆ¶èŠ‚ç‚¹ï¼‰
            group.children.forEach(child => {
                flatTasks.push({
                    title: child.text,
                    is_parent: child.isParent, // å‘Šè¯‰åç«¯è¿™æ˜¯çˆ¶èŠ‚ç‚¹
                    words: child.isParent ? 0 : Math.max(200, perWord) // çˆ¶èŠ‚ç‚¹0å­—ï¼Œå¶å­èŠ‚ç‚¹åˆ†é…å­—æ•°
                });
            });
        });

        // UI çŠ¶æ€æ›´æ–°
        const btn = document.getElementById('btnSubmit');
        const logArea = document.getElementById('logArea');
        const resultDiv = document.getElementById('resultContent');
        const ctrlDiv = document.getElementById('controlButtons');
        
        btn.disabled = true;
        ctrlDiv.style.display = 'block';
        document.getElementById('btnPause').innerText = "â¸ æš‚åœ";
        resultDiv.innerHTML = "";
        fullMarkdownText = "";
        
        const formData = new FormData();
        formData.append('title', document.getElementById('paperTitle').value);
        formData.append('references', document.getElementById('references').value);
        formData.append('chapter_data', JSON.stringify(flatTasks)); // å‘é€åŒ…å« is_parent æ ‡è®°çš„ä»»åŠ¡
        formData.append('task_id', currentTaskId);

        try {
            const response = await fetch('/generate', { method: 'POST', body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.replace('data: ', ''));
                            if (data.type === 'log') logArea.innerHTML += `<div>> ${data.msg}</div>`;
                            else if (data.type === 'content') {
                                fullMarkdownText += data.md;
                                resultDiv.innerHTML = marked.parse(fullMarkdownText);
                            }
                            else if (data.type === 'done') {
                                btn.disabled = false;
                                ctrlDiv.style.display = 'none';
                            }
                            logArea.scrollTop = logArea.scrollHeight;
                        } catch (e) {}
                    }
                }
            }
        } catch (err) {
            alert("Error: " + err);
            btn.disabled = false;
        }
    };

    // æš‚åœ/åœæ­¢/å¯¼å‡º å‡½æ•°ä¿æŒä¸å˜ (å¤ç”¨ä¹‹å‰çš„ä»£ç )
    async function togglePause() { /* åŒä¸Šä¸ªç‰ˆæœ¬ */
        const btn = document.getElementById('btnPause');
        const action = isPaused ? 'resume' : 'pause';
        await fetch('/control', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ task_id: currentTaskId, action: action })});
        isPaused = !isPaused;
        btn.innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
        btn.className = isPaused ? "btn btn-info btn-sm me-2" : "btn btn-warning btn-sm me-2";
    }
    async function stopTask() { /* åŒä¸Šä¸ªç‰ˆæœ¬ */ 
        if(!confirm("ç¡®å®šåœæ­¢ï¼Ÿ")) return;
        await fetch('/control', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ task_id: currentTaskId, action: 'stop' })});
        document.getElementById('btnSubmit').disabled = false;
        document.getElementById('controlButtons').style.display = 'none';
    }
    function exportToMarkdown() {
        if(!fullMarkdownText) return;
        const blob = new Blob([fullMarkdownText], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'thesis_result.md';
        a.click();
    }
</script>
</body>
</html>