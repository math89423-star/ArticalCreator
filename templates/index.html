<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ·±åº¦è®ºæ–‡ç”ŸæˆåŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .sidebar { background: white; padding: 25px; border-right: 1px solid #e0e0e0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .output-area { background: white; padding: 40px; min-height: 100vh; overflow-y: auto; position: relative;}
        
        /* æ—¥å¿—åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        #logArea { 
            font-size: 0.85rem; 
            background: #212529; 
            color: #00ff9d; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            height: 300px; 
            min-height: 150px;
            max-height: 600px;
            resize: vertical; 
            overflow-y: auto; 
            margin-top: auto; 
            border: 1px solid #444;
            line-height: 1.5;
        }

        /* ç« èŠ‚å¡ç‰‡æ ·å¼ */
        .chapter-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chapter-header {
            background: #f8f9fa;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        .chapter-body {
            padding: 5px;
        }
        .leaf-row {
            display: flex;
            align-items: center;
            padding: 6px 5px;
            border-bottom: 1px dashed #f0f0f0;
        }
        .leaf-row:last-child { border-bottom: none; }
        .leaf-row:hover { background-color: #fcfcfc; }
        
        .leaf-title-input {
            border: none;
            background: transparent;
            font-size: 0.9rem;
            color: #555;
            width: 100%;
            margin-right: 10px;
        }
        .leaf-title-input:focus {
            background: #fff;
            outline: 2px solid #b3d7ff;
            border-radius: 3px;
        }
        
        .word-input-group {
            display: flex;
            align-items: center;
            width: 110px;
            flex-shrink: 0;
        }
        
        textarea { font-size: 0.85rem !important; resize: vertical; }
        .markdown-body h2 { border-left: 5px solid #0d6efd; padding-left: 10px; margin-top: 40px; color: #2c3e50; font-size: 1.6rem;}
        .step-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; }

        .control-bar {
            position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100;
            padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px);
        }

        /* ç™»å½•é®ç½© */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px; width: 400px;
            text-align: center;
        }
        
        .history-item {
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.85rem; color: #666;
        }
        .history-item:hover { background: #f8f9fa; color: #0d6efd; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3 class="mb-4 fw-bold text-primary">ğŸ” è®ºæ–‡åŠ©æ‰‹ - ç”¨æˆ·ç™»å½•</h3>
        <p class="text-muted mb-4">è¯·è¾“å…¥ç®¡ç†å‘˜åˆ†å‘çš„å¡å¯† (Key)</p>
        <input type="text" id="userIdInput" class="form-control form-control-lg mb-3" placeholder="ä¾‹å¦‚: key_xxxx">
        <button class="btn btn-primary w-100 btn-lg" id="loginBtn" onclick="handleLogin()">éªŒè¯å¹¶ç™»å½•</button>
        <div class="mt-3 text-muted small">
            <span id="loginMsg"></span>
        </div>
    </div>
</div>

<div class="container-fluid g-0" id="mainApp" style="filter: blur(5px);">
    <div class="row g-0">
        <div class="col-md-4">
            <div class="sidebar">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold text-primary m-0"><i class="bi bi-gear-fill"></i> è®ºæ–‡é…ç½®</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            ğŸ‘¤ <span id="displayUserId">Guest</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showHistory()">ğŸ“œ å†å²è®°å½•</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </div>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button type="button" class="btn btn-outline-success fw-bold" onclick="createNewPaper()">
                        <i class="bi bi-plus-circle-fill"></i> âœ¨ æ–°å»ºè®ºæ–‡
                    </button>
                </div>
                
                <form id="paperForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">1</span>è®ºæ–‡é¢˜ç›®</label>
                        <input type="text" class="form-control" id="paperTitle" placeholder="è¾“å…¥è®ºæ–‡é¢˜ç›®" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span><span class="step-badge">2</span>å®Œæ•´å¤§çº² (ç”¨äºè§£æ)</span>
                            <a href="#" class="text-decoration-none small" onclick="loadDemoOutline()">å¡«å…¥ç¤ºä¾‹</a>
                        </label>
                        <textarea class="form-control" id="outlineRaw" rows="6" placeholder="ç²˜è´´å¤§çº²æ–‡æœ¬..." required></textarea>
                        <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-1" onclick="parseOutline()">â¬‡ï¸ 1. è§£æå¤§çº²å¹¶ç”Ÿæˆé…ç½®</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between align-items-center">
                            <span class="step-badge">3</span>ç« èŠ‚ä¸å­—æ•°å¾®è°ƒ
                            <span class="badge bg-light text-dark border">æ€»å­—æ•°: <span id="totalWords">0</span></span>
                        </label>
                        
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text bg-light fw-bold">ç›®æ ‡æ€»å­—æ•°</span>
                            <input type="number" id="globalTotalWords" class="form-control" value="5000" step="500">
                            <button class="btn btn-outline-secondary" type="button" onclick="smartDistributeWords()">ğŸ”„ 2. æ™ºèƒ½åˆ†é…</button>
                        </div>

                        <div id="chapterConfigArea" style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; padding: 5px; border-radius: 4px; background: #fdfdfd;">
                            <div class="text-center text-muted small py-4">è¯·å…ˆç‚¹å‡»ä¸Šæ–¹â€œè§£æå¤§çº²â€æŒ‰é’®...</div>
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-light w-100 mt-1 text-muted border-dashed" style="border:1px dashed #ccc" onclick="addManualChapter()">
                            <i class="bi bi-plus-circle"></i> æ–°å¢ä¸€çº§ç« èŠ‚
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">4</span>å‚è€ƒæ–‡çŒ®</label>
                        <textarea class="form-control" id="references" rows="3" placeholder="ç²˜è´´å‚è€ƒæ–‡çŒ®..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">5</span>çœŸå®ç ”ç©¶æ•°æ® (å¯é€‰)</label>
                        <textarea class="form-control" id="customData" rows="3" placeholder="ç²˜è´´å®éªŒæ•°æ®/è°ƒæŸ¥ç»“æœ..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">ğŸš€ 3. å¼€å§‹ç”Ÿæˆ</button>
                </form>
                <div id="logArea" class="mt-3">ç­‰å¾…å°±ç»ª...</div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="output-area">
                <div class="control-bar mb-4">
                    <h4 class="m-0 text-dark">ğŸ“„ ç”Ÿæˆç»“æœé¢„è§ˆ</h4>
                    <div id="controlButtons" style="display: none;">
                        <button class="btn btn-outline-danger btn-sm me-2" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                        <button class="btn btn-warning btn-sm me-2" id="btnPause" onclick="togglePause()">â¸ æš‚åœ</button>
                        <button class="btn btn-danger btn-sm me-2" id="btnStop" onclick="stopTask()">â¹ åœæ­¢</button>
                        <button class="btn btn-success btn-sm me-2" onclick="exportToMarkdown()">ğŸ“¥ å¯¼å‡º MD</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToDocx()">ğŸ“„ å¯¼å‡º Word (Docx)</button>
                    </div>
                </div>
                <div id="resultContent" class="markdown-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <p style="font-size: 1.2rem;">ğŸ’¡ ç™»å½• -> è§£æå¤§çº² -> æ™ºèƒ½åˆ†é… -> å¼€å§‹ç”Ÿæˆ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“œ å†å²è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="historyList"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // å…¨å±€çŠ¶æ€
    let currentUserId = null;
    let parsedStructure = []; // ç»“æ„: [{ title: "ç« å", children: [{text: "1.1...", words: 500, isParent: false}, ...] }]
    let fullMarkdownText = "";
    let currentTaskId = "";
    let isPaused = false;
    let abortController = null; // ã€æ–°å¢ã€‘ç”¨äºå¼ºåˆ¶ç»ˆæ­¢è¯·æ±‚

    // --- ç”¨æˆ·ç³»ç»Ÿ ---
    window.onload = async function() {
        const storedUser = localStorage.getItem('paper_active_user');
        if (storedUser) {
            // æ¯æ¬¡åˆ·æ–°é¡µé¢æ—¶ï¼Œé™é»˜éªŒè¯ä¸€ä¸‹æœ¬åœ°å­˜å‚¨çš„ Key æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
            // å¦‚æœè¢«ç®¡ç†å‘˜å°ç¦äº†ï¼Œéœ€è¦è¸¢å‡º
            try {
                const res = await fetch('/verify_login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: storedUser })
                });
                if (res.ok) {
                    currentUserId = storedUser;
                    initWorkspace();
                } else {
                    logout(); // Key å¤±æ•ˆï¼Œå¼ºåˆ¶ç™»å‡º
                }
            } catch(e) {
                // ç½‘ç»œé”™è¯¯ç­‰ï¼Œæš‚æ—¶å…è®¸è¿›å…¥æˆ–æ˜¾ç¤ºé”™è¯¯
                console.error("Auth check failed", e);
            }
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    };

    async function authenticatedFetch(url, options = {}) {
        if (!options.headers) options.headers = {};
        if (!(options.body instanceof FormData)) options.headers['Content-Type'] = 'application/json';
        options.headers['X-User-ID'] = currentUserId;
        return fetch(url, options);
    }

    async function handleLogin() {
        const inputId = document.getElementById('userIdInput').value.trim();
        const msgSpan = document.getElementById('loginMsg');
        const btn = document.getElementById('loginBtn');
        
        if (!inputId) {
            msgSpan.innerText = "è¯·è¾“å…¥å¡å¯†";
            msgSpan.className = "text-danger";
            return;
        }

        btn.disabled = true;
        btn.innerText = "éªŒè¯ä¸­...";

        try {
            const res = await fetch('/verify_login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: inputId })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                currentUserId = inputId;
                localStorage.setItem('paper_active_user', currentUserId);
                msgSpan.innerText = "ç™»å½•æˆåŠŸï¼";
                msgSpan.className = "text-success";
                setTimeout(() => {
                    initWorkspace();
                }, 500);
            } else {
                msgSpan.innerText = data.msg || "ç™»å½•å¤±è´¥";
                msgSpan.className = "text-danger";
                btn.disabled = false;
                btn.innerText = "éªŒè¯å¹¶ç™»å½•";
            }
        } catch (e) {
            msgSpan.innerText = "ç½‘ç»œè¯·æ±‚é”™è¯¯";
            msgSpan.className = "text-danger";
            btn.disabled = false;
            btn.innerText = "éªŒè¯å¹¶ç™»å½•";
        }
    }

    function initWorkspace() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.filter = 'none';
        document.getElementById('displayUserId').innerText = currentUserId;
        loadDraft(currentUserId);
    }

    function logout() {
        localStorage.removeItem('paper_active_user');
        location.reload();
    }

    // --- æ ¸å¿ƒé€»è¾‘ï¼šå¤§çº²è§£æä¸é…ç½® ---

    function loadDemoOutline() {
        document.getElementById('outlineRaw').value = `æ‘˜è¦\nç¬¬ä¸€ç«  ç»ªè®º\n1.1 ç ”ç©¶èƒŒæ™¯\n1.2 ç ”ç©¶æ„ä¹‰\nç¬¬äºŒç«  æ ¸å¿ƒç†è®º\n2.1 ç†è®ºåŸºç¡€\n2.2 æ¡†æ¶åˆ†æ\nç¬¬ä¸‰ç«  æ€»ç»“\nå‚è€ƒæ–‡çŒ®`;
        parseOutline();
    }

    // è§£æå¤§çº²æ–‡æœ¬ -> ç»“æ„åŒ–æ•°æ®
    function parseOutline() {
        const text = document.getElementById('outlineRaw').value;
        const lines = text.split('\n');
        let processedLines = [];
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if(!trimmed) return;
            const level = getLineLevel(trimmed, line);
            // åˆå§‹åŒ–å­—æ•°é»˜è®¤ä¸º0ï¼Œç¨åæ™ºèƒ½åˆ†é…
            processedLines.push({ text: trimmed, level: level, isParent: false, words: 0 });
        });

        // æ ‡è®°çˆ¶èŠ‚ç‚¹ (å¦‚æœåœ¨å®ƒåé¢æœ‰æ›´é«˜å±‚çº§çš„èŠ‚ç‚¹)
        for (let i = 0; i < processedLines.length - 1; i++) {
            if (processedLines[i+1].level > processedLines[i].level) {
                processedLines[i].isParent = true;
            }
        }

        // æ„å»ºåˆ†ç»„ç»“æ„
        parsedStructure = [];
        let currentMainGroup = null;

        processedLines.forEach(item => {
            // åˆ¤æ–­æ˜¯å¦ä¸ºä¸€çº§ç« èŠ‚ï¼ˆæˆ–ç‰¹æ®Šç« èŠ‚ï¼‰
            const isTopLevel = item.level === 1 || ["æ‘˜è¦", "Abstract", "å‚è€ƒæ–‡çŒ®", "è‡´è°¢", "æ€»ç»“"].some(k => item.text.includes(k) && item.text.length < 10);
            
            if (isTopLevel) {
                currentMainGroup = { 
                    title: item.text, 
                    children: [] 
                };
                parsedStructure.push(currentMainGroup);
                
                // å¦‚æœä¸€çº§ç« èŠ‚æœ¬èº«ä¸æ˜¯çˆ¶èŠ‚ç‚¹ï¼ˆä¾‹å¦‚â€œæ‘˜è¦â€ä¸‹é¢æ²¡æœ‰1.1ï¼‰ï¼Œå®ƒè‡ªå·±ä¹Ÿæ˜¯ä¸€ä¸ªå†™ä½œç‚¹
                if (!item.isParent) {
                    currentMainGroup.children.push({ text: item.text, isParent: false, words: 0 });
                }
            } else {
                // å¦‚æœå¼€å¤´æ²¡æœ‰ä¸€çº§ç« èŠ‚ï¼Œåˆ›å»ºé»˜è®¤ç»„
                if (!currentMainGroup) {
                    currentMainGroup = { title: "å‰è¨€/å…¶ä»–", children: [] };
                    parsedStructure.push(currentMainGroup);
                }
                // äºŒçº§/ä¸‰çº§èŠ‚ç‚¹ä½œä¸ºå†™ä½œç‚¹åŠ å…¥å½“å‰ç»„
                currentMainGroup.children.push({ text: item.text, isParent: item.isParent, words: 0 });
            }
        });
        
        // è§£æåç«‹å³è¿›è¡Œä¸€æ¬¡æ™ºèƒ½åˆ†é…
        smartDistributeWords();
    }

    // æ™ºèƒ½åˆ†é…å­—æ•°ç®—æ³•
    function smartDistributeWords() {
        const totalTarget = parseInt(document.getElementById('globalTotalWords').value) || 5000;
        let reserved = 0;
        let activeLeaves = []; // å­˜å‚¨æ‰€æœ‰éœ€è¦åˆ†é…å­—æ•°çš„å¶å­èŠ‚ç‚¹

        // 1. éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¯†åˆ«ç‰¹æ®Šç« èŠ‚
        parsedStructure.forEach(group => {
            group.children.forEach(child => {
                if (child.isParent) return; // çˆ¶èŠ‚ç‚¹ä¸å†™å†…å®¹

                // æ‘˜è¦å›ºå®šå­—æ•°
                if (child.text.includes("æ‘˜è¦") || child.text.includes("Abstract")) {
                    child.words = 400;
                    reserved += 400;
                }
                // å‚è€ƒæ–‡çŒ®ä¸å å­—æ•°
                else if (child.text.includes("å‚è€ƒæ–‡çŒ®") || child.text.includes("è‡´è°¢")) {
                    child.words = 0;
                }
                else {
                    activeLeaves.push(child);
                }
            });
        });

        // 2. å¹³å‡åˆ†é…å‰©ä½™å­—æ•°
        let remaining = Math.max(0, totalTarget - reserved);
        const count = activeLeaves.length || 1;
        let avgWords = Math.floor(remaining / count);
        // è§„æ•´åˆ° 50 çš„å€æ•°
        avgWords = Math.round(avgWords / 50) * 50;
        avgWords = Math.max(200, avgWords); // ä¿åº•200å­—

        activeLeaves.forEach(leaf => {
            leaf.words = avgWords;
        });

        // 3. é‡æ–°æ¸²æŸ“ç•Œé¢
        renderConfigArea();
    }

    // æ¸²æŸ“é…ç½®åŒºåŸŸ (æ ¸å¿ƒ UI)
    function renderConfigArea() {
        const container = document.getElementById('chapterConfigArea');
        container.innerHTML = '';
        let currentTotal = 0;

        parsedStructure.forEach((group, gIdx) => {
            const card = document.createElement('div');
            card.className = 'chapter-card';

            // å¤´éƒ¨ï¼šç« èŠ‚å + åˆ é™¤æŒ‰é’®
            const header = document.createElement('div');
            header.className = 'chapter-header';
            header.innerHTML = `
                <span><i class="bi bi-folder2-open me-1"></i> ${group.title}</span>
                <div>
                    <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="sortLeaves(${gIdx})" title="æŒ‰æ ‡é¢˜åºå·è‡ªåŠ¨æ’åº"><i class="bi bi-sort-numeric-down"></i></button>
                    <button class="btn btn-sm btn-link text-success p-0 me-2" onclick="addLeaf(${gIdx})" title="æ·»åŠ å†™ä½œç‚¹"><i class="bi bi-plus-circle"></i></button>
                    <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteGroup(${gIdx})" title="åˆ é™¤æ•´ç« "><i class="bi bi-trash"></i></button>
                </div>
            `;
            card.appendChild(header);

            // å†…å®¹ï¼šå†™ä½œç‚¹åˆ—è¡¨
            const body = document.createElement('div');
            body.className = 'chapter-body';

            group.children.forEach((child, cIdx) => {
                if (child.isParent) return; // ä»…æ˜¾ç¤ºå¶å­èŠ‚ç‚¹ï¼ˆå®é™…å†™ä½œç‚¹ï¼‰

                currentTotal += child.words;
                const row = document.createElement('div');
                row.className = 'leaf-row';
                row.innerHTML = `
                    <div class="flex-grow-1">
                        <input type="text" class="leaf-title-input" value="${child.text}" 
                               onchange="updateLeaf(${gIdx}, ${cIdx}, 'text', this.value)">
                    </div>
                    <div class="word-input-group">
                        <input type="number" class="form-control form-control-sm word-input" 
                               value="${child.words}" step="50" min="0" 
                               onchange="updateLeaf(${gIdx}, ${cIdx}, 'words', this.value)">
                        <span class="ms-1 small text-muted">å­—</span>
                    </div>
                    <button class="btn btn-sm text-secondary ms-2" onclick="deleteLeaf(${gIdx}, ${cIdx})" title="åˆ é™¤æ­¤èŠ‚"><i class="bi bi-x"></i></button>
                `;
                body.appendChild(row);
            });

            card.appendChild(body);
            container.appendChild(card);
        });

        document.getElementById('totalWords').innerText = currentTotal;
    }

    // --- æ•°æ®æ“ä½œå‡½æ•° ---

    function updateLeaf(gIdx, cIdx, field, value) {
        if (field === 'words') value = parseInt(value) || 0;
        parsedStructure[gIdx].children[cIdx][field] = value;
        
        if (field === 'words') {
            let total = 0;
            parsedStructure.forEach(g => g.children.forEach(c => { if(!c.isParent) total += c.words; }));
            document.getElementById('totalWords').innerText = total;
        }
        
        // [æ ¸å¿ƒä¿®æ”¹] å¦‚æœä¿®æ”¹äº†æ ‡é¢˜æ–‡æœ¬ï¼Œé‡æ–°æ’åº
        if (field === 'text') {
            // ä¸ºäº†é˜²æ­¢ç”¨æˆ·æ­£åœ¨è¾“å…¥æ—¶é¢‘ç¹è·³åŠ¨ï¼Œå¯ä»¥è€ƒè™‘ä¸åšå®æ—¶æ’åºï¼Œæˆ–è€…åªåœ¨å¤±ç„¦æ—¶æ’åºã€‚
            // é‰´äºè¿™é‡Œæ˜¯ onchange (å¤±ç„¦è§¦å‘)ï¼Œç›´æ¥æ’åºæ˜¯å®‰å…¨çš„ã€‚
            sortLeaves(gIdx);
        }
    }

    function deleteLeaf(gIdx, cIdx) {
        parsedStructure[gIdx].children.splice(cIdx, 1);
        renderConfigArea();
    }

    function addLeaf(gIdx) {
        // æ™ºèƒ½æ¨æµ‹ä¸‹ä¸€ä¸ªåºå·
        const group = parsedStructure[gIdx];
        let nextNum = 1;
        const lastLeaf = group.children[group.children.length - 1];
        if (lastLeaf) {
            const match = lastLeaf.text.match(/(\d+)$/); // å°è¯•åŒ¹é…æœ«å°¾æ•°å­—
            if (match) nextNum = parseInt(match[1]) + 1;
            else {
                // å°è¯•åŒ¹é…åƒ 2.1 è¿™æ ·çš„ç»“æ„
                const matchDot = lastLeaf.text.match(/\.(\d+)\s/);
                if (matchDot) nextNum = parseInt(matchDot[1]) + 1;
            }
        }
        // æç¤ºç”¨æˆ·è¾“å…¥
        const defaultTitle = `${gIdx + 1}.${group.children.length + 1} æ–°å¢å°èŠ‚`; // é»˜è®¤å ä½ç¬¦
        const title = prompt("è¯·è¾“å…¥æ–°å°èŠ‚æ ‡é¢˜ (å»ºè®®åŒ…å«åºå·ä»¥ä¾¿è‡ªåŠ¨æ’åºï¼Œå¦‚ '2.2 æ•°æ®åˆ†æ'):", defaultTitle);
        
        if (title) {
            parsedStructure[gIdx].children.push({ text: title, isParent: false, words: 500 });
            // [æ ¸å¿ƒä¿®æ”¹] æ·»åŠ åç«‹å³å°è¯•æ’åº
            sortLeaves(gIdx); 
        }
    }

    function deleteGroup(gIdx) {
        if(confirm("ç¡®å®šåˆ é™¤è¯¥ç« èŠ‚åŠå…¶æ‰€æœ‰å†…å®¹å—ï¼Ÿ")) {
            parsedStructure.splice(gIdx, 1);
            renderConfigArea();
        }
    }

    function addManualChapter() {
        const title = prompt("è¯·è¾“å…¥æ–°ç« èŠ‚æ ‡é¢˜ (ä¾‹å¦‚: ç¬¬å››ç«  å®éªŒåˆ†æ)", "æ–°ç« èŠ‚");
        if(title) {
            parsedStructure.push({
                title: title,
                children: [{ text: title + " æ¦‚è¿°", isParent: false, words: 500 }]
            });
            renderConfigArea();
        }
    }

    // --- æäº¤é€»è¾‘ (ç”Ÿæˆä»»åŠ¡åˆ—è¡¨) ---
    document.getElementById('paperForm').onsubmit = async (e) => {
        e.preventDefault();
        saveDraft();
        // --- 1. å¦‚æœæœ‰æ—§çš„è¯·æ±‚åœ¨è·‘ï¼Œå…ˆæ€æ‰ ---
        if (abortController) {
            abortController.abort();
        }
        abortController = new AbortController();
        
        // æ¢å¤æ£€æµ‹
        let isResuming = false;
        let existingContext = "";
        if (fullMarkdownText && fullMarkdownText.trim().length > 50) {
            const userChoice = confirm("æ£€æµ‹åˆ°å·²æœ‰å†…å®¹ã€‚\nã€ç¡®å®šã€‘ç»§ç»­ç”Ÿæˆ (è·³è¿‡å·²å®Œæˆ)\nã€å–æ¶ˆã€‘æ¸…ç©ºé‡å†™");
            if (userChoice) {
                isResuming = true;
                existingContext = fullMarkdownText.slice(-3000);
            } else {
                clearResults(true); 
            }
        }

        currentTaskId = generateUUID();
        isPaused = false;
        
        // æ„å»ºä»»åŠ¡åˆ—è¡¨ï¼šæ‰å¹³åŒ–å¤„ç†
        const flatTasks = [];
        parsedStructure.forEach(group => {
            // 1. æ·»åŠ ç« èŠ‚çˆ¶ä»»åŠ¡ (ç”¨äºç”Ÿæˆä¸€çº§æ ‡é¢˜ ## ç¬¬ä¸€ç« )
            flatTasks.push({
                title: group.title,
                is_parent: true,
                words: 0
            });

            // 2. æ·»åŠ æ‰€æœ‰å­ä»»åŠ¡ (å®é™…å†™ä½œå†…å®¹)
            group.children.forEach(child => {
                if (!child.isParent) {
                    flatTasks.push({
                        title: child.text,
                        is_parent: false,
                        words: child.words
                    });
                }
            });
        });

        // è¿‡æ»¤å·²å®Œæˆä»»åŠ¡
        let tasksToSend = flatTasks;
        if (isResuming) {
            tasksToSend = flatTasks.filter(task => {
                // å¦‚æœæ˜¯çˆ¶æ ‡é¢˜ï¼Œæˆ–è€…å·²ç»ç”Ÿæˆè¿‡çš„å­æ ‡é¢˜ï¼Œéƒ½è·³è¿‡
                const headerPattern = new RegExp(`#{1,3}\\s*${escapeRegExp(task.title)}`, 'i');
                return !headerPattern.test(fullMarkdownText);
            });
            if (tasksToSend.length === 0) {
                alert("æ‰€æœ‰ç« èŠ‚å‡å·²å­˜åœ¨ï¼");
                return;
            }
            appendLog(`ğŸ”„ æ¢å¤ç”Ÿæˆï¼Œå‰©ä½™ ${tasksToSend.length} ä¸ªä»»åŠ¡...`, 'warn');
        } else {
            appendLog("ğŸš€ å¼€å§‹æ–°ä»»åŠ¡...", 'info');
        }

        // UI çŠ¶æ€é”å®š
        const btn = document.getElementById('btnSubmit');
        const logArea = document.getElementById('logArea');
        const resultDiv = document.getElementById('resultContent');
        const ctrlDiv = document.getElementById('controlButtons');
        
        btn.disabled = true;
        ctrlDiv.style.display = 'block';
        document.getElementById('btnPause').innerText = "â¸ æš‚åœ";
        document.getElementById('btnPause').style.display = 'inline-block';
        document.getElementById('btnStop').style.display = 'inline-block';
        toggleInputs(true);

        const formData = new FormData();
        formData.append('title', document.getElementById('paperTitle').value);
        formData.append('references', document.getElementById('references').value);
        formData.append('custom_data', document.getElementById('customData').value);
        formData.append('chapter_data', JSON.stringify(tasksToSend));
        formData.append('task_id', currentTaskId);
        formData.append('initial_context', existingContext); 

        // å‘é€è¯·æ±‚
        try {
            const response = await authenticatedFetch('/generate', { method: 'POST', body: formData, signal: abortController.signal });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop();

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(trimmed.replace('data: ', ''));
                            if (data.type === 'log') {
                                appendLog(data.msg); 
                            } else if (data.type === 'content') {
                                fullMarkdownText += data.md;
                                resultDiv.innerHTML = marked.parse(fullMarkdownText);
                                saveDraft(); 
                            } else if (data.type === 'done') {
                                btn.disabled = false;
                                saveDraft();
                                appendLog("ğŸ‰ ç”Ÿæˆå®Œæˆï¼", 'info'); 
                                alert("ç”Ÿæˆå®Œæˆï¼");
                                toggleInputs(false);
                                abortController = null;
                            }
                        } catch (e) {}
                    }
                }
            }
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('ç”¨æˆ·æ‰‹åŠ¨åœæ­¢äº†å‰ç«¯è¯·æ±‚');
                // è¿™é‡Œä¸éœ€è¦ alert æŠ¥é”™ï¼Œå› ä¸ºæ˜¯ç”¨æˆ·è‡ªå·±ç‚¹çš„åœæ­¢
            }
            else {
                appendLog("âŒ å¼‚å¸¸: " + err, 'error');
                btn.disabled = false;
                toggleInputs(false); 
            }
        }
    };

    // --- è¾…åŠ©å·¥å…· ---
    function getLineLevel(text, rawLine) {
        if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ç« |éƒ¨åˆ†]/.test(text)) return 1;
        if (/^(æ‘˜è¦|Abstract|å‚è€ƒæ–‡çŒ®|è‡´è°¢|æ€»ç»“)/.test(text)) return 1;
        if (/^(\d+(\.\d+)*)/.test(text)) return text.match(/^(\d+(\.\d+)*)/)[1].split('.').length; 
        return 2; 
    }

    function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c === 'x' ? Math.random() * 16 | 0 : (Math.random() * 16 | 0) & 0x3 | 0x8).toString(16)); }
    function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function appendLog(msg, type = 'info') {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        let color = '#00ff9d';
        if (type === 'error') color = '#ff4d4d';
        if (type === 'warn') color = '#ffc107';
        logArea.innerHTML += `<div style="color:${color}; border-bottom:1px dashed #333; padding:2px 0;">[${time}] ${msg}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }
    
    function toggleInputs(shouldDisable) {
        const ids = ['paperTitle', 'outlineRaw', 'references', 'customData', 'globalTotalWords'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = shouldDisable;
        });
        // é”å®šæ‰€æœ‰åŠ¨æ€ç”Ÿæˆçš„è¾“å…¥æ¡†
        document.querySelectorAll('.leaf-title-input').forEach(i => i.disabled = shouldDisable);
        document.querySelectorAll('.word-input').forEach(i => i.disabled = shouldDisable);
        // é”å®šæŒ‰é’®
        document.querySelectorAll('.chapter-header button').forEach(b => b.disabled = shouldDisable);
        document.querySelectorAll('.leaf-row button').forEach(b => b.disabled = shouldDisable);
    }

    // --- æŒ‰é’®åŠŸèƒ½ ---
    async function togglePause() { 
        const btn = document.getElementById('btnPause');
        const action = isPaused ? 'resume' : 'pause';
        appendLog(isPaused ? "â–¶ ç»§ç»­ä»»åŠ¡" : "â¸ æš‚åœä»»åŠ¡", 'warn');
        await authenticatedFetch('/control', {method: 'POST', body: JSON.stringify({ task_id: currentTaskId, action: action })});
        isPaused = !isPaused;
        btn.innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
        btn.className = isPaused ? "btn btn-info btn-sm me-2" : "btn btn-warning btn-sm me-2";
    }
    
    async function stopTask() { 
        if(!confirm("ç¡®å®šåœæ­¢ï¼Ÿ")) 
            return;
        // ã€æ–°å¢ã€‘å‰ç«¯å¼ºåˆ¶ç»ˆæ­¢è¿æ¥
        if (abortController) {
            abortController.abort(); // è¿™ä¼šç›´æ¥æŠ›å‡º AbortErrorï¼Œè·³å‡º onsubmit çš„å¾ªç¯
            abortController = null;
        }
        await authenticatedFetch('/control', {method: 'POST', body: JSON.stringify({ task_id: currentTaskId, action: 'stop' })});
        document.getElementById('btnSubmit').disabled = false;
        document.getElementById('btnPause').style.display = 'none';
        document.getElementById('btnStop').style.display = 'none';
        appendLog("â¹ ä»»åŠ¡å·²ç»ˆæ­¢", 'error');
        toggleInputs(false);
    }

    function createNewPaper() {
        if (fullMarkdownText && fullMarkdownText.length > 50) {
            if (!confirm("âš ï¸ æ–°å»ºå°†æ¸…ç©ºå½“å‰æ‰€æœ‰å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        }
        clearResults(true);
        document.getElementById('paperTitle').value = "";
        document.getElementById('outlineRaw').value = "";
        document.getElementById('references').value = "";
        document.getElementById('customData').value = "";
        document.getElementById('chapterConfigArea').innerHTML = "<div class='text-center text-muted small py-4'>è¯·å…ˆç‚¹å‡»ä¸Šæ–¹â€œè§£æå¤§çº²â€...</div>";
        document.getElementById('totalWords').innerText = "0";
        parsedStructure = [];
        appendLog("âœ¨ å·²é‡ç½®å·¥ä½œå°", 'info');
    }

    function clearResults(silent = false) {
        if (!silent && !confirm("ç¡®å®šæ¸…ç©ºæ­£æ–‡å†…å®¹å—ï¼Ÿ(é…ç½®ä¿ç•™)")) return;
        fullMarkdownText = "";
        document.getElementById('resultContent').innerHTML = "<div class='text-center text-muted mt-5 pt-5'><p style='font-size: 1.2rem;'>ğŸ’¡ å†…å®¹å·²æ¸…ç©º</p></div>";
        document.getElementById('controlButtons').style.display = 'none';
        document.getElementById('btnSubmit').disabled = false;
        toggleInputs(false);
        saveDraft();
        if(!silent) appendLog("ğŸ—‘ï¸ å†…å®¹å·²æ¸…ç©º", 'warn');
    }

    function exportToMarkdown() {
        if(!fullMarkdownText) return;
        const blob = new Blob([fullMarkdownText], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'thesis_result.md';
        a.click();
    }

    async function exportToDocx() {
        if(!fullMarkdownText) { alert("æ— å†…å®¹ï¼"); return; }
        try {
            const response = await authenticatedFetch('/export_docx', {
                method: 'POST',
                body: JSON.stringify({ content: fullMarkdownText })
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (document.getElementById('paperTitle').value || 'thesis') + ".docx";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else alert("å¯¼å‡ºå¤±è´¥");
        } catch (e) { alert("é”™è¯¯: " + e); }
    }

    // --- å†å²è®°å½• ---
    function saveDraft() {
        if (!currentUserId) return;
        const draft = {
            title: document.getElementById('paperTitle').value,
            outline: document.getElementById('outlineRaw').value,
            refs: document.getElementById('references').value,
            customData: document.getElementById('customData').value,
            content: fullMarkdownText,
            structure: parsedStructure, // æ–°å¢ï¼šä¿å­˜ç»“æ„åŒ–é…ç½®
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(`draft_${currentUserId}_current`, JSON.stringify(draft));
        
        let history = JSON.parse(localStorage.getItem(`history_${currentUserId}`) || "[]");
        const idx = history.findIndex(h => h.title === draft.title);
        if (idx > -1) history[idx] = draft;
        else history.unshift(draft);
        if(history.length > 5) history.pop();
        localStorage.setItem(`history_${currentUserId}`, JSON.stringify(history));
    }

    function loadDraft(uid) {
        const draftStr = localStorage.getItem(`draft_${uid}_current`);
        if (draftStr) {
            const draft = JSON.parse(draftStr);
            document.getElementById('paperTitle').value = draft.title || "";
            document.getElementById('outlineRaw').value = draft.outline || "";
            document.getElementById('references').value = draft.refs || "";
            document.getElementById('customData').value = draft.customData || "";
            
            // ä¼˜å…ˆæ¢å¤ç»“æ„åŒ–é…ç½®ï¼Œå¦åˆ™è§£æå¤§çº²
            if (draft.structure && draft.structure.length > 0) {
                parsedStructure = draft.structure;
                renderConfigArea();
                // é‡æ–°è®¡ç®—æ€»å­—æ•°
                let total = 0;
                parsedStructure.forEach(g => g.children.forEach(c => { if(!c.isParent) total += c.words; }));
                document.getElementById('totalWords').innerText = total;
            } else if(draft.outline) {
                parseOutline();
            }

            if (draft.content && draft.content.trim().length > 0) {
                fullMarkdownText = draft.content;
                document.getElementById('resultContent').innerHTML = marked.parse(fullMarkdownText);
                document.getElementById('controlButtons').style.display = 'block';
                document.getElementById('btnSubmit').disabled = true;
                toggleInputs(true);
            }
        }
    }

    function showHistory() {
        const listEl = document.getElementById('historyList');
        listEl.innerHTML = "";
        const history = JSON.parse(localStorage.getItem(`history_${currentUserId}`) || "[]");
        if(history.length === 0) listEl.innerHTML = "<div class='text-center text-muted'>æš‚æ— è®°å½•</div>";
        else {
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<strong>${item.title || 'æ— æ ‡é¢˜'}</strong> <br><small>${new Date(item.timestamp).toLocaleString()}</small>`;
                div.onclick = () => {
                    if(confirm("åŠ è½½å†å²å°†è¦†ç›–å½“å‰å†…å®¹ï¼Œç¡®å®šï¼Ÿ")) {
                        // ä¸´æ—¶ä¿å­˜åˆ° localStorage draftï¼Œç„¶åè°ƒç”¨ loadDraft
                        localStorage.setItem(`draft_${currentUserId}_current`, JSON.stringify(item));
                        loadDraft(currentUserId);
                        bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
                        clearResults(true); // æ¸…ç†æ­£æ–‡æ˜¾ç¤ºçŠ¶æ€ï¼ˆè™½ç„¶loadDraftä¼šæ¢å¤ï¼Œä½†é‡ç½®ä¸€ä¸‹æ›´å®‰å…¨ï¼‰
                        if(item.content) {
                             document.getElementById('controlButtons').style.display = 'block';
                             document.getElementById('resultContent').innerHTML = marked.parse(item.content);
                             fullMarkdownText = item.content;
                        }
                    }
                };
                listEl.appendChild(div);
            });
        }
        new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    function sortLeaves(gIdx) {
        const group = parsedStructure[gIdx];
        // æå–å­èŠ‚ç‚¹ï¼ˆæ’é™¤çˆ¶èŠ‚ç‚¹ï¼‰
        const leaves = group.children.filter(c => !c.isParent);
        // æš‚æ—¶ç§»é™¤ leavesï¼Œä¿ç•™ isParent èŠ‚ç‚¹ï¼ˆé€šå¸¸æ²¡æœ‰ï¼Œæˆ–è€…åœ¨æœ€å‰ï¼‰
        const parents = group.children.filter(c => c.isParent);

        leaves.sort((a, b) => {
            // æå–æ ‡é¢˜ä¸­çš„æ•°å­—ç‰ˆæœ¬å· (ä¾‹å¦‚ "2.1.3" -> [2, 1, 3])
            const extractVersion = (str) => {
                const match = str.match(/^(\d+(\.\d+)*)/);
                return match ? match[0].split('.').map(Number) : [9999]; // æ²¡æ•°å­—çš„æ’åé¢
            };
            
            const vA = extractVersion(a.text);
            const vB = extractVersion(b.text);
            
            for (let i = 0; i < Math.max(vA.length, vB.length); i++) {
                const numA = vA[i] || 0;
                const numB = vB[i] || 0;
                if (numA !== numB) return numA - numB;
            }
            return 0;
        });

        // åˆå¹¶å› children
        group.children = [...parents, ...leaves];
        renderConfigArea(); // åˆ·æ–°ç•Œé¢
    }


</script>
</body>
</html>