<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ·±åº¦è®ºæ–‡ç”ŸæˆåŠ©æ‰‹ (æ™ºèƒ½å¤§çº²ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .sidebar { background: white; padding: 25px; border-right: 1px solid #e0e0e0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .output-area { background: white; padding: 40px; min-height: 100vh; overflow-y: auto; position: relative;}
        #logArea { font-size: 0.8rem; background: #212529; color: #00ff9d; padding: 15px; border-radius: 6px; font-family: monospace; height: 150px; overflow-y: auto; margin-top: auto; border: 1px solid #444;}
        
        .chapter-config-item { 
            background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-config-item .label { font-weight: 600; font-size: 0.9rem; color: #495057; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;}
        
        textarea { font-size: 0.85rem !important; resize: vertical; }
        .markdown-body h2 { border-left: 5px solid #0d6efd; padding-left: 10px; margin-top: 40px; color: #2c3e50; font-size: 1.6rem;}
        .markdown-body p { text-align: justify; line-height: 1.8; margin-bottom: 1.2rem; color: #333; }
        .step-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; }

        .control-bar {
            position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100;
            padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

<div class="container-fluid g-0">
    <div class="row g-0">
        <div class="col-md-4">
            <div class="sidebar">
                <h5 class="mb-4 fw-bold text-primary"><i class="bi bi-gear-fill"></i> è®ºæ–‡é…ç½®å·¥ä½œå°</h5>
                <form id="paperForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">1</span>è®ºæ–‡é¢˜ç›®</label>
                        <input type="text" class="form-control" id="paperTitle" placeholder="è¾“å…¥è®ºæ–‡é¢˜ç›®" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span><span class="step-badge">2</span>å®Œæ•´å¤§çº² (æ”¯æŒå„ç§æ ¼å¼)</span>
                            <a href="#" class="text-decoration-none small" onclick="loadDemoOutline()">å¡«å…¥ç¤ºä¾‹</a>
                        </label>
                        <textarea class="form-control" id="outlineRaw" rows="12" placeholder="ç›´æ¥ç²˜è´´ä½ çš„å¤§çº²ï¼Œä¾‹å¦‚ï¼š&#10;ç¬¬ä¸€ç«  ç»ªè®º&#10;1.1 ç ”ç©¶èƒŒæ™¯&#10;..." required oninput="parseOutline()"></textarea>
                        <div class="form-text text-muted small">ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«çˆ¶å­å±‚çº§ï¼Œçˆ¶æ ‡é¢˜ä¸ç”Ÿæˆå†…å®¹ã€‚</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">3</span>å†™ä½œå­—æ•°åˆ†é…</label>
                        <div id="chapterConfigArea" style="max-height: 250px; overflow-y: auto;">
                            <div class="text-center text-muted small py-3">è¯·è¾“å…¥å¤§çº²...</div>
                        </div>
                        <div class="text-end mt-1">
                            <small class="fw-bold text-primary">æ€»è®¡é¢„ä¼°: <span id="totalWords">0</span> å­—</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">4</span>å‚è€ƒæ–‡çŒ®</label>
                        <textarea class="form-control" id="references" rows="5" placeholder="è¯·ç²˜è´´å‚è€ƒæ–‡çŒ®..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                </form>
                <div id="logArea" class="mt-3">ç­‰å¾…å°±ç»ª...</div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="output-area">
                <div class="control-bar mb-4">
                    <h4 class="m-0 text-dark">ğŸ“„ ç”Ÿæˆç»“æœé¢„è§ˆ</h4>
                    <div id="controlButtons" style="display: none;">
                        <button class="btn btn-warning btn-sm me-2" id="btnPause" onclick="togglePause()">â¸ æš‚åœ</button>
                        <button class="btn btn-danger btn-sm me-2" onclick="stopTask()">â¹ åœæ­¢</button>
                        <button class="btn btn-success btn-sm me-2" onclick="exportToMarkdown()">ğŸ“¥ å¯¼å‡º MD</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToDocx()">ğŸ“„ å¯¼å‡º Word (Docx)</button>
                    </div>
                </div>
                <div id="resultContent" class="markdown-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <p style="font-size: 1.2rem;">ğŸ’¡ æ™ºèƒ½è¯†åˆ«å¤§çº²å±‚çº§ï¼Œæ”¯æŒä¸­æ–‡ç« èŠ‚ã€é˜¿æ‹‰ä¼¯æ•°å­—ç­‰å¤šç§æ ¼å¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let parsedStructure = []; 
    let fullMarkdownText = "";
    let currentTaskId = "";
    let isPaused = false;

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c === 'x' ? Math.random() * 16 | 0 : (Math.random() * 16 | 0) & 0x3 | 0x8).toString(16));
    }

    function loadDemoOutline() {
        document.getElementById('outlineRaw').value = `æ‘˜è¦
ç¬¬ä¸€ç«  ç»ªè®º
1.1 ç ”ç©¶èƒŒæ™¯åŠæ„ä¹‰
1.2 å›½å†…å¤–ç ”ç©¶ç°çŠ¶
1.2.1 å›½å¤–ç ”ç©¶ç°çŠ¶
1.2.2 å›½å†…ç ”ç©¶ç°çŠ¶
1.3 ä¸»è¦ç ”ç©¶å†…å®¹
ç¬¬äºŒç«  ç›¸å…³ç†è®ºåŸºç¡€
2.1 æ·±åº¦å­¦ä¹ ç†è®º
2.2 ç¥ç»ç½‘ç»œæ¨¡å‹
ç¬¬ä¸‰ç«  æ ¸å¿ƒç®—æ³•è®¾è®¡
3.1 æ•°æ®é¢„å¤„ç†
3.2 æ¨¡å‹æ¶æ„
ç¬¬å››ç«  å®éªŒä¸åˆ†æ
ç¬¬äº”ç«  æ€»ç»“ä¸å±•æœ›
å‚è€ƒæ–‡çŒ®`;
        parseOutline();
    }

    // --- æ ¸å¿ƒï¼šæ™ºèƒ½å±‚çº§è§£æç®—æ³• ---
    function parseOutline() {
        const text = document.getElementById('outlineRaw').value;
        const lines = text.split('\n'); // ä¸å…ˆ trimï¼Œä¿ç•™ç¼©è¿›ä¿¡æ¯ä»¥å¤‡ç”¨
        
        // 1. é¢„å¤„ç†è¡Œï¼šè®¡ç®—å±‚çº§ (Level)
        let processedLines = [];
        lines.forEach(line => {
            const trimmed = line.trim();
            if(!trimmed) return;
            
            const level = getLineLevel(trimmed, line);
            processedLines.push({
                text: trimmed,
                level: level,
                isParent: false // é»˜è®¤ä¸º falseï¼Œåç»­è®¡ç®—
            });
        });

        // 2. è¯†åˆ«çˆ¶å­å…³ç³»ï¼šå¦‚æœä¸‹ä¸€è¡Œçš„ level > å½“å‰è¡Œ levelï¼Œåˆ™å½“å‰è¡Œä¸ºçˆ¶èŠ‚ç‚¹
        for (let i = 0; i < processedLines.length - 1; i++) {
            if (processedLines[i+1].level > processedLines[i].level) {
                processedLines[i].isParent = true;
            }
        }

        // 3. åˆ†ç»„æ„å»º UI ç»“æ„
        parsedStructure = [];
        let currentMainGroup = null;

        processedLines.forEach(item => {
            // Level 1 (ç¬¬ä¸€ç« /1.) æˆ– ç‰¹æ®Šç« èŠ‚ (æ‘˜è¦/ç»“è®º) è§†ä¸ºé¡¶çº§åˆ†ç»„
            const isTopLevel = item.level === 1 || ["æ‘˜è¦", "Abstract", "å‚è€ƒæ–‡çŒ®", "è‡´è°¢", "ç»“è®º", "æ€»ç»“"].some(k => item.text.includes(k) && item.text.length < 10);
            
            if (isTopLevel) {
                currentMainGroup = { 
                    title: item.text, 
                    children: [], 
                    defaultWords: 1000 
                };
                // å¦‚æœé¡¶çº§ç« èŠ‚æœ¬èº«ä¸æ˜¯çˆ¶èŠ‚ç‚¹ï¼ˆå³å®ƒä¸‹é¢æ²¡æœ‰å°æ ‡é¢˜ï¼‰ï¼Œå®ƒè‡ªå·±ä¹Ÿè¦å†™å†…å®¹
                // ä½†ä¸ºäº†ç»Ÿä¸€ï¼Œæˆ‘ä»¬æŠŠé¡¶çº§ç« èŠ‚ä¹Ÿä½œä¸ºä¸€è¡ŒåŠ å…¥ children
                currentMainGroup.children.push(item);
                parsedStructure.push(currentMainGroup);
            } else {
                if (!currentMainGroup) {
                    // å¤„ç†å¼€å¤´æ²¡æœ‰é¡¶çº§ç« èŠ‚çš„æƒ…å†µï¼ˆå¦‚ç›´æ¥å¼€å§‹å†™ 1.1ï¼‰
                    currentMainGroup = { title: "å‰è¨€/å…¶ä»–", children: [], defaultWords: 500 };
                    parsedStructure.push(currentMainGroup);
                }
                currentMainGroup.children.push(item);
            }
        });
        
        renderConfigArea();
    }

    // --- æ™ºèƒ½å±‚çº§åˆ¤æ–­å‡½æ•° ---
    function getLineLevel(text, rawLine) {
        // ç­–ç•¥ 1: å…³é”®å­—åŒ¹é… (Level 1)
        if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ç« |éƒ¨åˆ†]/.test(text)) return 1;
        if (/^Chapter\s+\d+/i.test(text)) return 1;
        if (/^(æ‘˜è¦|Abstract|å‚è€ƒæ–‡çŒ®|è‡´è°¢|ç»“è®º|æ€»ç»“ä¸å±•æœ›)/.test(text)) return 1;

        // ç­–ç•¥ 2: æ•°å­—ç¼–å·åŒ¹é… (1.1.1)
        const match = text.match(/^(\d+(\.\d+)*)/);
        if (match) {
            const parts = match[1].split('.').filter(p => p); // è¿‡æ»¤æ‰ç©ºä¸²
            // "1" -> level 1, "1.1" -> level 2, "1.1.1" -> level 3
            return parts.length; 
        }

        // ç­–ç•¥ 3: ä¸­æ–‡å°æ ‡é¢˜åŒ¹é… (ä¸€ã€ (ä¸€) 1ã€)
        if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/.test(text)) return 2;
        if (/^ï¼ˆ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ï¼‰/.test(text)) return 3;
        
        // ç­–ç•¥ 4: ç¼©è¿›æ£€æµ‹ (å¦‚æœæ²¡æœ‰æ˜æ˜¾ç¼–å·ï¼Œé ç¼©è¿›)
        const leadingSpaces = rawLine.match(/^\s*/)[0].length;
        if (leadingSpaces >= 4) return 3;
        if (leadingSpaces >= 2) return 2;

        return 2; // é»˜è®¤ä½œä¸ºäºŒçº§æ ‡é¢˜
    }

    function renderConfigArea() {
        const container = document.getElementById('chapterConfigArea');
        container.innerHTML = '';
        let totalWords = 0;

        parsedStructure.forEach((group, index) => {
            // è®¡ç®—è¿™ä¸ªå¤§ç»„é‡Œæœ‰å¤šå°‘ä¸ªâ€œå¶å­èŠ‚ç‚¹â€ï¼ˆå³å®é™…éœ€è¦å†™å­—çš„ç« èŠ‚ï¼‰
            // æ’é™¤æ‰æ‰€æœ‰ isParent=true çš„èŠ‚ç‚¹
            const leafCount = group.children.filter(c => !c.isParent).length;
            
            // æ™ºèƒ½é¢„è®¾å­—æ•°
            let w = 1000;
            if (group.title.includes("æ‘˜è¦") || group.title.includes("Abstract")) w = 350;
            else if (group.title.includes("å‚è€ƒæ–‡çŒ®")) w = 0; // å‚è€ƒæ–‡çŒ®ä¸åˆ†é…ç”Ÿæˆå­—æ•°
            else if (leafCount > 3) w = leafCount * 400; 
            
            if (w > 0) totalWords += w;

            // åªæœ‰éœ€è¦å†™å­—çš„ç« èŠ‚æ‰æ˜¾ç¤ºé…ç½®
            if (w > 0 || leafCount > 0) {
                const div = document.createElement('div');
                div.className = 'chapter-config-item';
                div.innerHTML = `
                    <div>
                        <div class="label" title="${group.title}">${group.title}</div>
                        <div class="sub-count">
                            <span class="badge bg-secondary" style="font-size:0.6rem">${leafCount} ä¸ªå†™ä½œç‚¹</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <input type="number" class="form-control form-control-sm word-input" 
                               data-idx="${index}" value="${w}" step="50" min="0" onchange="recalcTotal()">
                        <span class="ms-1 small text-muted">å­—</span>
                    </div>
                `;
                container.appendChild(div);
            }
        });
        document.getElementById('totalWords').innerText = totalWords;
    }

    function recalcTotal() {
        let total = 0;
        document.querySelectorAll('.word-input').forEach(i => total += parseInt(i.value)||0);
        document.getElementById('totalWords').innerText = total;
    }

    // --- æäº¤é€»è¾‘ ---
    document.getElementById('paperForm').onsubmit = async (e) => {
        e.preventDefault();
        currentTaskId = generateUUID();
        isPaused = false;
        
        const inputs = document.querySelectorAll('.word-input');
        const flatTasks = [];

        // éå†UIä¸Šçš„å¤§ç»„
        parsedStructure.forEach((group, index) => {
            let totalAssigned = 0;
            const inputEl = document.querySelector(`.word-input[data-idx="${index}"]`);
            if (inputEl) totalAssigned = parseInt(inputEl.value) || 0;

            const leafNodes = group.children.filter(c => !c.isParent);
            const leafCount = leafNodes.length;
            const perWord = leafCount > 0 ? Math.floor(totalAssigned / leafCount) : 0;

            group.children.forEach(child => {
                if (child.text.includes("å‚è€ƒæ–‡çŒ®") && child.level === 1) return;

                flatTasks.push({
                    title: child.text,
                    is_parent: child.isParent, 
                    words: child.isParent ? 0 : Math.max(200, perWord) 
                });
            });
        });

        const btn = document.getElementById('btnSubmit');
        const logArea = document.getElementById('logArea');
        const resultDiv = document.getElementById('resultContent');
        const ctrlDiv = document.getElementById('controlButtons');
        
        btn.disabled = true;
        // å…³é”®ä¿®å¤ï¼šç«‹å³æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
        ctrlDiv.style.display = 'block';
        document.getElementById('btnPause').innerText = "â¸ æš‚åœ";
        resultDiv.innerHTML = "";
        fullMarkdownText = "";
        
        const formData = new FormData();
        formData.append('title', document.getElementById('paperTitle').value);
        formData.append('references', document.getElementById('references').value);
        formData.append('chapter_data', JSON.stringify(flatTasks));
        formData.append('task_id', currentTaskId);

        try {
            const response = await fetch('/generate', { method: 'POST', body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.replace('data: ', ''));
                            if (data.type === 'log') logArea.innerHTML += `<div>> ${data.msg}</div>`;
                            else if (data.type === 'content') {
                                fullMarkdownText += data.md;
                                resultDiv.innerHTML = marked.parse(fullMarkdownText);
                            }
                            else if (data.type === 'done') {
                                btn.disabled = false;
                                // ä»»åŠ¡å®Œæˆæ—¶ä¿æŒæ˜¾ç¤ºï¼Œæ–¹ä¾¿å¯¼å‡º
                                ctrlDiv.style.display = 'block';
                            }
                            logArea.scrollTop = logArea.scrollHeight;
                        } catch (e) {}
                    }
                }
            }
        } catch (err) {
            alert("Error: " + err);
            btn.disabled = false;
        }
    };

    async function togglePause() { 
        const btn = document.getElementById('btnPause');
        const action = isPaused ? 'resume' : 'pause';
        await fetch('/control', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ task_id: currentTaskId, action: action })});
        isPaused = !isPaused;
        btn.innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
        btn.className = isPaused ? "btn btn-info btn-sm me-2" : "btn btn-warning btn-sm me-2";
    }
    async function stopTask() { 
        if(!confirm("ç¡®å®šåœæ­¢ï¼Ÿ")) return;
        await fetch('/control', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ task_id: currentTaskId, action: 'stop' })});
        document.getElementById('btnSubmit').disabled = false;
        // åœæ­¢åä¹Ÿä¿ç•™æ˜¾ç¤ºï¼Œä¹Ÿè®¸ç”¨æˆ·æƒ³å¯¼å‡ºå·²ç”Ÿæˆçš„éƒ¨åˆ†
        // document.getElementById('controlButtons').style.display = 'none'; 
    }
    
    function exportToMarkdown() {
        if(!fullMarkdownText) return;
        const blob = new Blob([fullMarkdownText], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'thesis_result.md';
        a.click();
    }

    async function exportToDocx() {
        if(!fullMarkdownText) {
            alert("æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹ï¼");
            return;
        }
        
        try {
            const response = await fetch('/export_docx', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: fullMarkdownText })
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = document.getElementById('paperTitle').value + "_è®ºæ–‡.docx" || 'thesis_result.docx';
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                alert("å¯¼å‡ºå¤±è´¥");
            }
        } catch (e) {
            alert("å¯¼å‡ºé”™è¯¯: " + e);
        }
    }
</script>
</body>
</html>