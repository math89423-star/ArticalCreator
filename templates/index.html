<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ·±åº¦è®ºæ–‡ç”ŸæˆåŠ©æ‰‹ (å¤šç”¨æˆ·ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .sidebar { background: white; padding: 25px; border-right: 1px solid #e0e0e0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
        .output-area { background: white; padding: 40px; min-height: 100vh; overflow-y: auto; position: relative;}
        #logArea { 
            font-size: 0.85rem; 
            background: #212529; 
            color: #00ff9d; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            height: 300px; /* é»˜è®¤é«˜åº¦å¢åŠ  */
            min-height: 150px;
            max-height: 600px;
            resize: vertical; /* å…è®¸å‚ç›´æ‹‰ä¼¸ */
            overflow-y: auto; 
            margin-top: auto; 
            border: 1px solid #444;
            line-height: 1.5;
        }
        .chapter-config-item { 
            background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .chapter-config-item .label { font-weight: 600; font-size: 0.9rem; color: #495057; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;}
        
        textarea { font-size: 0.85rem !important; resize: vertical; }
        .markdown-body h2 { border-left: 5px solid #0d6efd; padding-left: 10px; margin-top: 40px; color: #2c3e50; font-size: 1.6rem;}
        .markdown-body p { text-align: justify; line-height: 1.8; margin-bottom: 1.2rem; color: #333; }
        .step-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; }

        .control-bar {
            position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100;
            padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px);
        }

        /* ç™»å½•é®ç½©å±‚ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px; width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
        }
        
        /* å†å²è®°å½• */
        .history-item {
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
            font-size: 0.85rem; color: #666;
        }
        .history-item:hover { background: #f8f9fa; color: #0d6efd; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3 class="mb-4 fw-bold text-primary">ğŸ” æ¬¢è¿ä½¿ç”¨è®ºæ–‡åŠ©æ‰‹</h3>
        <p class="text-muted mb-4">è¯·è¾“å…¥æ‚¨çš„ User ID ä»¥åŒæ­¥å·¥ä½œåŒº</p>
        <input type="text" id="userIdInput" class="form-control form-control-lg mb-3" placeholder="ä¾‹å¦‚: user_123">
        <button class="btn btn-primary w-100 btn-lg" onclick="handleLogin()">è¿›å…¥å·¥ä½œå°</button>
        <div class="mt-3 text-muted small">å¦‚æœæ²¡æœ‰IDï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ª</div>
    </div>
</div>

<div class="container-fluid g-0" id="mainApp" style="filter: blur(5px);">
    <div class="row g-0">
        <div class="col-md-4">
            <div class="sidebar">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold text-primary m-0"><i class="bi bi-gear-fill"></i> è®ºæ–‡é…ç½®</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            ğŸ‘¤ <span id="displayUserId">Guest</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showHistory()">ğŸ“œ å†å²è®°å½•</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </div>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button type="button" class="btn btn-outline-success fw-bold" onclick="createNewPaper()">
                        <i class="bi bi-plus-circle-fill"></i> âœ¨ æ–°å»ºè®ºæ–‡
                    </button>
                </div>
                <form id="paperForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">1</span>è®ºæ–‡é¢˜ç›®</label>
                        <input type="text" class="form-control" id="paperTitle" placeholder="è¾“å…¥è®ºæ–‡é¢˜ç›®" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span><span class="step-badge">2</span>å®Œæ•´å¤§çº² (æ”¯æŒå„ç§æ ¼å¼)</span>
                            <a href="#" class="text-decoration-none small" onclick="loadDemoOutline()">å¡«å…¥ç¤ºä¾‹</a>
                        </label>
                        <textarea class="form-control" id="outlineRaw" rows="8" placeholder="ç²˜è´´å¤§çº²..." required oninput="parseOutline()"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">3</span>å†™ä½œå­—æ•°åˆ†é…</label>
                        <div id="chapterConfigArea" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted small py-3">è¯·è¾“å…¥å¤§çº²...</div>
                        </div>
                        <div class="text-end mt-1">
                            <small class="fw-bold text-primary">æ€»è®¡é¢„ä¼°: <span id="totalWords">0</span> å­—</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">4</span>å‚è€ƒæ–‡çŒ®</label>
                        <textarea class="form-control" id="references" rows="4" placeholder="ç²˜è´´å‚è€ƒæ–‡çŒ®..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">5</span>çœŸå®ç ”ç©¶æ•°æ® (å¯é€‰)</label>
                        <textarea class="form-control" id="customData" rows="4" placeholder="ç²˜è´´å®éªŒæ•°æ®/è°ƒæŸ¥ç»“æœ..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                </form>
                <div id="logArea" class="mt-3">ç­‰å¾…å°±ç»ª...</div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="output-area">
                <div class="control-bar mb-4">
                    <h4 class="m-0 text-dark">ğŸ“„ ç”Ÿæˆç»“æœé¢„è§ˆ</h4>
                    <div id="controlButtons" style="display: none;">
                        <button class="btn btn-outline-danger btn-sm me-2" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                        <button class="btn btn-warning btn-sm me-2" id="btnPause" onclick="togglePause()">â¸ æš‚åœ</button>
                        <button class="btn btn-danger btn-sm me-2" id="btnStop" onclick="stopTask()">â¹ åœæ­¢</button>
                        <button class="btn btn-success btn-sm me-2" onclick="exportToMarkdown()">ğŸ“¥ å¯¼å‡º MD</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToDocx()">ğŸ“„ å¯¼å‡º Word (Docx)</button>
                    </div>
                </div>
                <div id="resultContent" class="markdown-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <p style="font-size: 1.2rem;">ğŸ’¡ è¯·å…ˆç™»å½•å¹¶é…ç½®è®ºæ–‡ä¿¡æ¯</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“œ å†å²è®°å½• (æœ¬åœ°ç¼“å­˜)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="historyList">
                </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentUserId = null;
    let parsedStructure = []; 
    let fullMarkdownText = "";
    let currentTaskId = "";
    let isPaused = false;

    // --- 1. ç”¨æˆ·ç™»å½•ä¸é‰´æƒé€»è¾‘ ---
    window.onload = function() {
        const storedUser = localStorage.getItem('paper_active_user');
        if (storedUser) {
            currentUserId = storedUser;
            initWorkspace();
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    };

    function appendLog(msg, type = 'info') {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        let color = '#00ff9d'; // é»˜è®¤ç»¿è‰²
        if (type === 'error') color = '#ff4d4d'; // çº¢è‰²
        if (type === 'warn') color = '#ffc107'; // é»„è‰²
        
        logArea.innerHTML += `<div style="color:${color}; border-bottom:1px dashed #333; padding:2px 0;">[${time}] ${msg}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }


    function handleLogin() {
        const inputId = document.getElementById('userIdInput').value.trim();
        if (!inputId) {
            // è‡ªåŠ¨ç”Ÿæˆ
            currentUserId = 'user_' + generateUUID().substring(0, 8);
            alert("å·²ä¸ºæ‚¨ç”Ÿæˆæ–°ID: " + currentUserId + "\nè¯·å¦¥å–„ä¿ç®¡æ­¤IDä»¥ä¾¿ä¸‹æ¬¡è®¿é—®ï¼");
        } else {
            currentUserId = inputId;
        }
        localStorage.setItem('paper_active_user', currentUserId);
        initWorkspace();
    }

    function initWorkspace() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.filter = 'none';
        document.getElementById('displayUserId').innerText = currentUserId;
        
        // å°è¯•åŠ è½½ä¸Šæ¬¡æœªå®Œæˆçš„è‰ç¨¿
        loadDraft(currentUserId);
    }

    function logout() {
        localStorage.removeItem('paper_active_user');
        location.reload();
    }

    function createNewPaper() {
        if (fullMarkdownText && fullMarkdownText.length > 50) {
            if (!confirm("âš ï¸ è­¦å‘Šï¼šå½“å‰å·²æœ‰ç”Ÿæˆçš„è®ºæ–‡å†…å®¹ã€‚\n\næ–°å»ºå°†ã€æ¸…ç©ºã€‘æ‰€æœ‰å·²è¾“å…¥çš„å¤§çº²ã€å‚è€ƒæ–‡çŒ®å’Œç”Ÿæˆç»“æœã€‚\n\næ˜¯å¦ç¡®è®¤æ–°å»ºï¼Ÿ")) {
                return;
            }
        toggleInputs(false);
        }
        
        // 1. æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('paperTitle').value = "";
        document.getElementById('outlineRaw').value = "";
        document.getElementById('references').value = "";
        document.getElementById('customData').value = "";
        
        // 2. æ¸…ç©ºé…ç½®åŒºå’Œæ€»å­—æ•°
        document.getElementById('chapterConfigArea').innerHTML = "<div class='text-center text-muted small py-3'>è¯·è¾“å…¥å¤§çº²...</div>";
        document.getElementById('totalWords').innerText = "0";
        
        // 3. æ¸…ç©ºç”Ÿæˆç»“æœå’Œæ—¥å¿—
        document.getElementById('resultContent').innerHTML = "<div class='text-center text-muted mt-5 pt-5'><p style='font-size: 1.2rem;'>ğŸ’¡ è¯·é…ç½®å¹¶å¼€å§‹æ–°è®ºæ–‡</p></div>";
        document.getElementById('logArea').innerText = "ç­‰å¾…å°±ç»ª...";
        
        // 4. é‡ç½®çŠ¶æ€å˜é‡
        fullMarkdownText = "";
        currentTaskId = "";
        parsedStructure = [];
        
        // 5. éšè—æ§åˆ¶æŒ‰é’®å¹¶å¯ç”¨å¼€å§‹æŒ‰é’®
        document.getElementById('controlButtons').style.display = 'none';
        document.getElementById('btnSubmit').disabled = false;
        
        // 6. æ¸…é™¤å½“å‰è‰ç¨¿ç¼“å­˜ (å¯é€‰ï¼Œä¿ç•™å†å²è®°å½•ä½†æ¸…ç©ºå½“å‰å·¥ä½œåŒº)
        if (currentUserId) {
            localStorage.removeItem(`draft_${currentUserId}_current`);
        }
        
        // æç¤º
        appendLog("âœ¨ å·²é‡ç½®å·¥ä½œå°ï¼Œè¯·å¼€å§‹æ–°åˆ›ä½œã€‚", 'info');
    }

    // --- 2. æ•°æ®æŒä¹…åŒ– (LocalStorage) ---
    function saveDraft() {
        if (!currentUserId) return;
        const draft = {
            title: document.getElementById('paperTitle').value,
            outline: document.getElementById('outlineRaw').value,
            refs: document.getElementById('references').value,
            customData: document.getElementById('customData').value,
            content: fullMarkdownText,
            timestamp: new Date().toISOString()
        };
        // ä¿å­˜å½“å‰è‰ç¨¿
        localStorage.setItem(`draft_${currentUserId}_current`, JSON.stringify(draft));
        
        // ä¿å­˜åˆ°å†å²è®°å½•åˆ—è¡¨ (ç®€å•å®ç°ï¼šåªå­˜æœ€æ–°çš„5æ¡)
        let history = JSON.parse(localStorage.getItem(`history_${currentUserId}`) || "[]");
        // å¦‚æœæ ‡é¢˜ç›¸åŒï¼Œæ›´æ–°ï¼›å¦åˆ™æ·»åŠ 
        const idx = history.findIndex(h => h.title === draft.title);
        if (idx > -1) history[idx] = draft;
        else history.unshift(draft);
        
        if(history.length > 5) history.pop();
        localStorage.setItem(`history_${currentUserId}`, JSON.stringify(history));
    }

    function loadDraft(uid) {
        const draftStr = localStorage.getItem(`draft_${uid}_current`);
        if (draftStr) {
            const draft = JSON.parse(draftStr);
            document.getElementById('paperTitle').value = draft.title || "";
            document.getElementById('outlineRaw').value = draft.outline || "";
            document.getElementById('references').value = draft.refs || "";
            document.getElementById('customData').value = draft.customData || "";
            
            parseOutline(); // é‡æ–°è§£æå¤§çº²UI
            
            // ã€ä¿®æ”¹ã€‘å¦‚æœå­˜åœ¨å·²ç”Ÿæˆçš„æ­£æ–‡å†…å®¹ï¼Œæ¢å¤ç•Œé¢å¹¶é”å®šè¾“å…¥
            if (draft.content && draft.content.trim().length > 0) {
                fullMarkdownText = draft.content;
                document.getElementById('resultContent').innerHTML = marked.parse(fullMarkdownText);
                document.getElementById('controlButtons').style.display = 'block';
                
                // æœ‰å†…å®¹å°±é”å®š
                toggleInputs(true);
                // ç¡®ä¿æŒ‰é’®æ˜¯æš‚åœ/ç»§ç»­çŠ¶æ€è€Œä¸æ˜¯åˆå§‹çŠ¶æ€
                document.getElementById('btnSubmit').disabled = true;
            } else {
                // æ²¡æœ‰æ­£æ–‡å†…å®¹ï¼ˆå¯èƒ½åªæ˜¯å¡«äº†è¡¨å•æ²¡ç”Ÿæˆï¼‰ï¼Œåˆ™è§£é”
                toggleInputs(false);
            }
        }
    }

    function showHistory() {
        const listEl = document.getElementById('historyList');
        listEl.innerHTML = "";
        const history = JSON.parse(localStorage.getItem(`history_${currentUserId}`) || "[]");
        
        if(history.length === 0) {
            listEl.innerHTML = "<div class='text-center text-muted'>æš‚æ— å†å²è®°å½•</div>";
        } else {
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<strong>${item.title || 'æ— æ ‡é¢˜'}</strong> <br><small>${new Date(item.timestamp).toLocaleString()}</small>`;
                div.onclick = () => {
                    if(confirm("åŠ è½½æ­¤å†å²è®°å½•å°†è¦†ç›–å½“å‰å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        fullMarkdownText = item.content || "";
                        document.getElementById('resultContent').innerHTML = marked.parse(fullMarkdownText);
                        document.getElementById('paperTitle').value = item.title;
                        document.getElementById('outlineRaw').value = item.outline;
                        document.getElementById('references').value = item.refs;
                        parseOutline();
                        const modal = bootstrap.Modal.getInstance(document.getElementById('historyModal'));
                        modal.hide();
                    }
                };
                listEl.appendChild(div);
            });
        }
        new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    // --- 3. å¢å¼º Fetch (å¸¦ User-ID) ---
    async function authenticatedFetch(url, options = {}) {
        if (!options.headers) options.headers = {};
        if (!(options.body instanceof FormData)) {
            options.headers['Content-Type'] = 'application/json';
        }
        // æ ¸å¿ƒï¼šæ‰€æœ‰è¯·æ±‚å¸¦ä¸Š User-ID
        options.headers['X-User-ID'] = currentUserId;
        return fetch(url, options);
    }

    // --- å·¥å…·å‡½æ•° ---
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c === 'x' ? Math.random() * 16 | 0 : (Math.random() * 16 | 0) & 0x3 | 0x8).toString(16));
    }

    function toggleInputs(shouldDisable) {
        // 1. é”å®šä¸»è¦æ–‡æœ¬åŸŸ
        const ids = ['paperTitle', 'outlineRaw', 'references', 'customData'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = shouldDisable;
        });

        // 2. é”å®šåŠ¨æ€ç”Ÿæˆçš„å­—æ•°è¾“å…¥æ¡†
        const wordInputs = document.querySelectorAll('.word-input');
        wordInputs.forEach(input => input.disabled = shouldDisable);

        // 3. é”å®š"å¡«å…¥ç¤ºä¾‹"é“¾æ¥ï¼Œé˜²æ­¢è¯¯ç‚¹
        const demoLink = document.querySelector('a[onclick="loadDemoOutline()"]');
        if (demoLink) {
            demoLink.style.pointerEvents = shouldDisable ? 'none' : 'auto';
            demoLink.style.opacity = shouldDisable ? '0.5' : '1';
            demoLink.style.cursor = shouldDisable ? 'not-allowed' : 'pointer';
        }
    }

    function loadDemoOutline() {
        document.getElementById('outlineRaw').value = `æ‘˜è¦\nç¬¬ä¸€ç«  ç»ªè®º\n1.1 ç ”ç©¶èƒŒæ™¯\n1.2 ç ”ç©¶æ„ä¹‰\nç¬¬äºŒç«  æ ¸å¿ƒç†è®º\nç¬¬ä¸‰ç«  æ€»ç»“\nå‚è€ƒæ–‡çŒ®`;
        parseOutline();
    }

    // æ™ºèƒ½å±‚çº§è§£æ (ä¿æŒä¸å˜ï¼Œç•¥å¾®ç²¾ç®€å±•ç¤º)
    function parseOutline() {
        const text = document.getElementById('outlineRaw').value;
        const lines = text.split('\n');
        let processedLines = [];
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if(!trimmed) return;
            const level = getLineLevel(trimmed, line);
            processedLines.push({ text: trimmed, level: level, isParent: false });
        });

        for (let i = 0; i < processedLines.length - 1; i++) {
            if (processedLines[i+1].level > processedLines[i].level) processedLines[i].isParent = true;
        }

        parsedStructure = [];
        let currentMainGroup = null;

        processedLines.forEach(item => {
            const isTopLevel = item.level === 1 || ["æ‘˜è¦", "Abstract", "å‚è€ƒæ–‡çŒ®"].some(k => item.text.includes(k));
            if (isTopLevel) {
                currentMainGroup = { title: item.text, children: [item] };
                parsedStructure.push(currentMainGroup);
            } else {
                if (!currentMainGroup) {
                    currentMainGroup = { title: "å‰è¨€", children: [] };
                    parsedStructure.push(currentMainGroup);
                }
                currentMainGroup.children.push(item);
            }
        });
        renderConfigArea();
    }

    function getLineLevel(text, rawLine) {
        if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ç« |éƒ¨åˆ†]/.test(text)) return 1;
        if (/^(æ‘˜è¦|Abstract|å‚è€ƒæ–‡çŒ®)/.test(text)) return 1;
        if (/^(\d+(\.\d+)*)/.test(text)) {
            return text.match(/^(\d+(\.\d+)*)/)[1].split('.').length; 
        }
        return 2; 
    }

    function renderConfigArea() {
        const container = document.getElementById('chapterConfigArea');
        container.innerHTML = '';
        let totalWords = 0;
        parsedStructure.forEach((group, index) => {
            const leafCount = group.children.filter(c => !c.isParent).length;
            let w = 1000;
            if (group.title.includes("æ‘˜è¦")) w = 350;
            else if (group.title.includes("å‚è€ƒæ–‡çŒ®")) w = 0;
            else if (leafCount > 3) w = leafCount * 400; 
            if (w > 0) totalWords += w;

            if (w > 0 || leafCount > 0) {
                const div = document.createElement('div');
                div.className = 'chapter-config-item';
                div.innerHTML = `
                    <div><div class="label">${group.title}</div></div>
                    <div class="d-flex align-items-center">
                        <input type="number" class="form-control form-control-sm word-input" 
                               data-idx="${index}" value="${w}" step="50" min="0" onchange="recalcTotal()">
                        <span class="ms-1 small text-muted">å­—</span>
                    </div>`;
                container.appendChild(div);
            }
        });
        document.getElementById('totalWords').innerText = totalWords;
    }

    function recalcTotal() {
        let total = 0;
        document.querySelectorAll('.word-input').forEach(i => total += parseInt(i.value)||0);
        document.getElementById('totalWords').innerText = total;
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
    }

    document.getElementById('paperForm').onsubmit = async (e) => {
        e.preventDefault();
        saveDraft(); // å…ˆä¿å­˜ä¸€ä¸‹å½“å‰çŠ¶æ€
        
        // --- 1. æ–­ç‚¹ç»­ä¼ åˆ¤æ–­ ---
        let isResuming = false;
        let existingContext = "";
        
        // å¦‚æœæ–‡æœ¬æ¡†é‡Œå·²ç»æœ‰è¾ƒå¤šå†…å®¹ï¼Œè¯¢é—®ç”¨æˆ·æ„å›¾
        if (fullMarkdownText && fullMarkdownText.trim().length > 50) {
            const userChoice = confirm(
                "æ£€æµ‹åˆ°æ‚¨æœ‰å·²ç”Ÿæˆçš„è®ºæ–‡å†…å®¹ã€‚\n\n" +
                "ã€ç¡®å®šã€‘ï¼šç»§ç»­ç”Ÿæˆï¼ˆè·³è¿‡å·²å­˜åœ¨çš„ç« èŠ‚ï¼Œä»æœ«å°¾ç»§ç»­ï¼‰\n" +
                "ã€å–æ¶ˆã€‘ï¼šæ¸…ç©ºé‡å†™ï¼ˆåˆ é™¤æ‰€æœ‰å†…å®¹ï¼Œä»å¤´å¼€å§‹ï¼‰"
            );
            
            if (userChoice) {
                isResuming = true;
                // æˆªå–æœ€å 3000 å­—ä½œä¸ºä¸Šä¸‹æ–‡å‘ç»™ AIï¼Œä¿è¯é€»è¾‘è¿è´¯
                existingContext = fullMarkdownText.slice(-3000);
            } else {
                fullMarkdownText = ""; // æ¸…ç©º
                document.getElementById('resultContent').innerHTML = "";
            }
        } else {
            fullMarkdownText = "";
            document.getElementById('resultContent').innerHTML = "";
        }

        currentTaskId = generateUUID();
        isPaused = false;
        
        // --- 2. æ„å»ºå®Œæ•´ä»»åŠ¡åˆ—è¡¨ ---
        const flatTasks = [];
        parsedStructure.forEach((group, index) => {
            let totalAssigned = parseInt(document.querySelector(`.word-input[data-idx="${index}"]`)?.value || 0);
            const leafNodes = group.children.filter(c => !c.isParent);
            const perWord = leafNodes.length > 0 ? Math.floor(totalAssigned / leafNodes.length) : 0;

            group.children.forEach(child => {
                if (child.text.includes("å‚è€ƒæ–‡çŒ®") && child.level === 1) return;
                flatTasks.push({
                    title: child.text,
                    is_parent: child.isParent, 
                    words: child.isParent ? 0 : Math.max(200, perWord) 
                });
            });
        });

        // --- 3. è¿‡æ»¤å‡ºéœ€è¦ç”Ÿæˆçš„ä»»åŠ¡ ---
        let tasksToSend = flatTasks;
        if (isResuming) {
            tasksToSend = flatTasks.filter(task => {
                // æ£€æŸ¥æ­£æ–‡ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¯¥ç« èŠ‚çš„æ ‡é¢˜ (ä¾‹å¦‚ "## 1.1 ç ”ç©¶èƒŒæ™¯")
                // ä½¿ç”¨æ­£åˆ™è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼Œå¿½ç•¥ # æ•°é‡å’Œç©ºæ ¼
                const headerPattern = new RegExp(`#{1,3}\\s*${escapeRegExp(task.title)}`, 'i');
                const isAlreadyGenerated = headerPattern.test(fullMarkdownText);
                return !isAlreadyGenerated; // å¦‚æœæ²¡æ‰¾åˆ°æ ‡é¢˜ï¼Œè¯´æ˜éœ€è¦ç”Ÿæˆ
            });

            if (tasksToSend.length === 0) {
                alert("æ ¹æ®å½“å‰å†…å®¹åˆ¤æ–­ï¼Œæ‰€æœ‰ç« èŠ‚å‡å·²ç”Ÿæˆå®Œæ¯•ï¼\n\nå¦‚æœæ‚¨æƒ³é‡å†™æŸç« èŠ‚ï¼Œè¯·åœ¨å³ä¾§é¢„è§ˆåŒºã€æ‰‹åŠ¨åˆ é™¤ã€‘è¯¥ç« èŠ‚çš„æ ‡é¢˜å’Œæ­£æ–‡ï¼Œç„¶åå†ç‚¹å¼€å§‹ã€‚");
                return;
            }
            document.getElementById('logArea').innerHTML += `<div class="text-warning">> ğŸ”„ æ¢å¤æ¨¡å¼ï¼šæ™ºèƒ½è·³è¿‡ ${flatTasks.length - tasksToSend.length} ä¸ªå·²å®Œæˆç« èŠ‚...</div>`;
        } else {
            document.getElementById('logArea').innerHTML = "<div>> ğŸš€ å¼€å§‹æ–°ä»»åŠ¡...</div>";
        }

        const btn = document.getElementById('btnSubmit');
        const logArea = document.getElementById('logArea');
        const resultDiv = document.getElementById('resultContent');
        const ctrlDiv = document.getElementById('controlButtons');
        
        btn.disabled = true;
        ctrlDiv.style.display = 'block';
        document.getElementById('btnPause').innerText = "â¸ æš‚åœ";
        toggleInputs(true);
        appendLog("ğŸ”’ å·²é”å®šé…ç½®ä¿¡æ¯ï¼Œç”Ÿæˆç»“æŸåå¯è§£é”ã€‚", 'info');
        const formData = new FormData();
        formData.append('title', document.getElementById('paperTitle').value);
        formData.append('references', document.getElementById('references').value);
        formData.append('custom_data', document.getElementById('customData').value);
        formData.append('chapter_data', JSON.stringify(tasksToSend)); // åªå‘é€å‰©ä¸‹çš„ä»»åŠ¡
        formData.append('task_id', currentTaskId);
        // ã€æ–°å¢ã€‘å‘é€ä¸Šä¸‹æ–‡ï¼Œè®©AIçŸ¥é“å‰é¢å†™äº†ä»€ä¹ˆ
        formData.append('initial_context', existingContext); 

        try {
            // ä½¿ç”¨é‰´æƒ fetch
            const response = await authenticatedFetch('/generate', { method: 'POST', body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                // ã€ä¿®å¤ç‚¹ 1ã€‘å¿…é¡»å…ˆä»æµä¸­è¯»å–æ•°æ®
                const { done, value } = await reader.read();
                if (done) break;
                
                // ã€ä¿®å¤ç‚¹ 2ã€‘è§£ç å¹¶æ‹¼æ¥åˆ°ç¼“å†²åŒº
                buffer += decoder.decode(value, { stream: true });
                
                // ã€ä¿®å¤ç‚¹ 3ã€‘æŒ‰åŒæ¢è¡Œç¬¦åˆ‡å‰²æ•°æ®åŒ…
                const lines = buffer.split('\n\n');
                
                // ã€ä¿®å¤ç‚¹ 4ã€‘ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„åŒ…ï¼Œç•™å¾…ä¸‹æ¬¡æ‹¼æ¥
                buffer = lines.pop();

                // ç°åœ¨ lines å˜é‡å·²å®šä¹‰ï¼Œå¯ä»¥éå†äº†
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(trimmed.replace('data: ', ''));
                            if (data.type === 'log') {
                                appendLog(data.msg); 
                            } else if (data.type === 'content') {
                                fullMarkdownText += data.md;
                                resultDiv.innerHTML = marked.parse(fullMarkdownText);
                                saveDraft(); 
                            } else if (data.type === 'done') {
                                btn.disabled = false;
                                saveDraft();
                                appendLog("ğŸ‰ è®ºæ–‡ç”Ÿæˆå…¨éƒ¨å®Œæˆï¼", 'info'); 
                                alert("ç”Ÿæˆå®Œæˆï¼");
                            }
                            logArea.scrollTop = logArea.scrollHeight;
                        } catch (e) {
                            console.warn("JSONè§£æè·³è¿‡:", e);
                        }
                    }
                }
            }
        } catch (err) {
            appendLog("âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸: " + err, 'error');
            alert("Error: " + err);
            btn.disabled = false;
        }
    };

    async function togglePause() { 
        const btn = document.getElementById('btnPause');
        const action = isPaused ? 'resume' : 'pause';
        
        // ã€æ–°å¢ã€‘æ—¥å¿—è¾“å‡º
        appendLog(isPaused ? "â–¶ ç”¨æˆ·ç‚¹å‡»ç»§ç»­ä»»åŠ¡..." : "â¸ ç”¨æˆ·ç‚¹å‡»æš‚åœä»»åŠ¡...", 'warn');
        
        try {
            await authenticatedFetch('/control', {
                method: 'POST', 
                body: JSON.stringify({ task_id: currentTaskId, action: action })
            });
            isPaused = !isPaused;
            btn.innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
            btn.className = isPaused ? "btn btn-info btn-sm me-2" : "btn btn-warning btn-sm me-2";
            
            // ã€æ–°å¢ã€‘ç¡®è®¤æ—¥å¿—
            appendLog(isPaused ? "âœ… ä»»åŠ¡å·²æš‚åœ" : "âœ… ä»»åŠ¡å·²æ¢å¤æ‰§è¡Œ");
        } catch (e) {
            appendLog("âŒ æ“ä½œå¤±è´¥: " + e, 'error');
        }
    }
    
    async function stopTask() { 
        if(!confirm("ç¡®å®šåœæ­¢ï¼Ÿ")) return;
        appendLog("â¹ ç”¨æˆ·è¯·æ±‚åœæ­¢ä»»åŠ¡...", 'error');
        try {
            await authenticatedFetch('/control', {
                method: 'POST', 
                body: JSON.stringify({ task_id: currentTaskId, action: 'stop' })
            });
            document.getElementById('btnSubmit').disabled = false;
            appendLog("âœ… ä»»åŠ¡å·²ç»ˆæ­¢");
        } catch (e) {
            appendLog("âŒ åœæ­¢å¤±è´¥: " + e, 'error');
        }
    }

    function exportToMarkdown() {
        if(!fullMarkdownText) return;
        const blob = new Blob([fullMarkdownText], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'thesis_result.md';
        a.click();
    }

    async function exportToDocx() {
        if(!fullMarkdownText) { alert("æ²¡æœ‰å†…å®¹ï¼"); return; }
        try {
            const response = await authenticatedFetch('/export_docx', {
                method: 'POST',
                body: JSON.stringify({ content: fullMarkdownText })
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (document.getElementById('paperTitle').value || 'thesis') + ".docx";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else alert("å¯¼å‡ºå¤±è´¥");
        } catch (e) { alert("å¯¼å‡ºé”™è¯¯: " + e); }
    }

    function clearResults() {
        // 1. å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œä¹Ÿç»™ä¸ªæç¤ºï¼Œé˜²æ­¢ç”¨æˆ·ä»¥ä¸ºæŒ‰é’®åäº†
        if (!fullMarkdownText && document.getElementById('resultContent').innerText.includes("è¯·å…ˆç™»å½•")) {
            alert("å½“å‰æ²¡æœ‰å¯æ¸…ç©ºçš„å†…å®¹ã€‚");
            return;
        }

        // 2. å¼¹å‡ºç¡®è®¤æ¡†
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰ç”Ÿæˆçš„æ‰€æœ‰æ­£æ–‡å†…å®¹å—ï¼Ÿ\n(æ‚¨çš„è®ºæ–‡é…ç½®å’Œå¤§çº²å°†ä¿ç•™ï¼Œä¸”å¯ä»¥é‡æ–°ç¼–è¾‘)")) return;
        
        // 3. æ‰§è¡Œæ¸…ç©ºæ“ä½œ
        fullMarkdownText = "";
        document.getElementById('resultContent').innerHTML = "<div class='text-center text-muted mt-5 pt-5'><p style='font-size: 1.2rem;'>ğŸ’¡ å†…å®¹å·²æ¸…ç©ºï¼Œè¯·é‡æ–°å¼€å§‹</p></div>";
        
        // 4. éšè—æ§åˆ¶æ ï¼Œé‡ç½®å¼€å§‹æŒ‰é’®
        document.getElementById('controlButtons').style.display = 'none';
        document.getElementById('btnSubmit').disabled = false;
        // ã€æ–°å¢ã€‘å†…å®¹æ¸…ç©ºåï¼Œè§£é”è¾“å…¥æ¡†ï¼Œå…è®¸ç”¨æˆ·ä¿®æ”¹
        toggleInputs(false);
        
        // 5. åŒæ­¥æ¸…é™¤ç¼“å­˜ (é˜²æ­¢åˆ·æ–°åå†…å®¹åˆå›æ¥äº†)
        if (typeof saveDraft === 'function') {
            saveDraft(); 
        }
        // 6. è®°å½•æ—¥å¿—
        if (typeof appendLog === 'function') {
            appendLog("ğŸ—‘ï¸ ç”¨æˆ·æ‰‹åŠ¨æ¸…ç©ºäº†ç”Ÿæˆå†…å®¹", 'warn');
        }
    }
</script>
</body>
</html>