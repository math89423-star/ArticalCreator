<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 深度论文生成助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="../static/style.css"> 
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3 class="mb-4 fw-bold text-primary">🔐 论文助手 - 用户登录</h3>
        <p class="text-muted mb-4">请输入管理员分发的卡密 (Key)</p>
        <input type="text" id="userIdInput" class="form-control form-control-lg mb-3" placeholder="例如: key_xxxx">
        <button class="btn btn-primary w-100 btn-lg" id="loginBtn">验证并登录</button>
        <div class="mt-3 text-muted small"><span id="loginMsg"></span></div>
    </div>
</div>

<div class="container-fluid g-0" id="mainApp" style="filter: blur(5px);">
    <div class="row g-0">
        <div class="col-md-4">
            <div class="sidebar">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold text-primary m-0"><i class="bi bi-gear-fill"></i> 论文配置</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            👤 <span id="displayUserId">Guest</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showHistory()">📜 历史记录</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">退出登录</a></li>
                        </ul>
                    </div>
                </div>

                <div class="card task-card mb-4" style="display: block !important; border: 2px solid #0d6efd !important;">
                    <div class="task-card-header d-flex justify-content-between align-items-center bg-white p-3 border-bottom">
                        <div>
                            <h6 class="m-0 fw-bold text-dark"><i class="bi bi-stack text-primary me-2"></i>并发任务</h6>
                            <small class="text-muted" style="font-size: 0.75rem;">点击切换不同论文</small>
                        </div>
                        <button class="btn btn-primary btn-sm rounded-circle shadow-sm" onclick="createNewTask()" title="新建任务" style="width: 32px; height: 32px; padding: 0;">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    
                    <div class="list-group list-group-flush" id="taskListContainer" style="max-height: 500px; overflow-y: auto; min-height: 250px; background: #fff;">
                        <div class="text-center text-muted py-3 small">正在加载任务...</div>
                    </div>
                </div>
        
                <div class="d-grid gap-2 mb-3">
                    <button type="button" class="btn btn-outline-success fw-bold" onclick="createNewPaper()">
                        <i class="bi bi-plus-circle-fill"></i> ✨ 新建论文
                    </button>
                </div>
        
                <form id="paperForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">1</span>论文题目</label>
                        <input type="text" class="form-control" id="paperTitle" placeholder="输入论文题目" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span><span class="step-badge">2</span>完整大纲 (用于解析)</span>
                            <a href="#" class="text-decoration-none small" onclick="loadDemoOutline()">填入示例</a>
                        </label>
                        <textarea class="form-control" id="outlineRaw" rows="6" placeholder="粘贴大纲文本..." required></textarea>
                        <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-1" onclick="parseOutline()">⬇️ 1. 解析大纲并生成配置</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between align-items-center">
                            <span class="step-badge">3</span>章节与字数微调
                            <span class="badge bg-light text-dark border">总字数: <span id="totalWords">0</span></span>
                        </label>
                        
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text bg-light fw-bold">目标总字数</span>
                            <input type="number" id="globalTotalWords" class="form-control" value="5000" step="500">
                            <button class="btn btn-outline-secondary" type="button" onclick="smartDistributeWords()">🔄 2. 智能分配</button>
                        </div>

                        <div id="chapterConfigArea" style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; padding: 5px; border-radius: 4px; background: #fdfdfd;">
                            <div class="text-center text-muted small py-4">请先点击上方“解析大纲”按钮...</div>
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-light w-100 mt-1 text-muted border-dashed" style="border:1px dashed #ccc" onclick="addManualChapter()">
                            <i class="bi bi-plus-circle"></i> 新增一级章节
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">4</span>参考文献配置</label>
                        <div class="mb-2">
                            <label class="form-label small text-muted">A. 国内参考文献 (用于国内现状)</label>
                            <textarea class="form-control" id="refDomestic" rows="3" placeholder="张三. 数字化转型研究[J]. ..."></textarea>
                        </div>
                        <div>
                            <label class="form-label small text-muted">B. 国外参考文献 (用于国外现状)</label>
                            <textarea class="form-control" id="refForeign" rows="3" placeholder="Smith J. Digital Transformation..."></textarea>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">5</span>真实研究数据 (支持上传)</label>
                        <div class="card p-2 mb-2 bg-light" style="border: 2px dashed #dee2e6;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted ms-2">支持 .xlsx, .csv, .docx, .pdf, .txt</span>
                                <label class="btn btn-sm btn-outline-primary" for="fileInput" style="cursor: pointer;">
                                    <i class="bi bi-folder-plus"></i> 选择文件
                                </label>
                                <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls,.txt,.pdf,.docx" style="display: none;" onchange="handleFileSelect()">
                            </div>
                            <div id="fileListDisplay" class="mt-2 small text-dark ps-2"></div>
                        </div>
                        <textarea class="form-control" id="customData" rows="2" placeholder="在此补充数据的文字说明，或直接粘贴小段文本..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">🚀 3. 开始生成</button>
                </form>
                <div id="logArea" class="mt-3">等待就绪...</div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="output-area">
                <div class="control-bar mb-4">
                    <h4 class="m-0 text-dark">📄 生成结果预览</h4>
                    <div id="controlButtons" style="display: none;">
                        <button class="btn btn-outline-danger btn-sm me-2" onclick="clearResults()">🗑️ 清空内容</button>
                        <button class="btn btn-warning btn-sm me-2" id="btnPause" onclick="togglePause()">⏸ 暂停</button>
                        <button class="btn btn-danger btn-sm me-2" id="btnStop" onclick="stopTask()">⏹ 停止</button>
                        <button class="btn btn-success btn-sm me-2" onclick="exportToMarkdown()">📥 导出 MD</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToDocx()">📄 导出 Word (Docx)</button>
                    </div>
                </div>
                <div id="resultContent" class="markdown-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <p style="font-size: 1.2rem;">💡 登录 -> 解析大纲 -> 智能分配 -> 开始生成</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📜 历史记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="historyList"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="rewriteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">🖊️ 重写章节</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">当前章节</label>
                    <input type="text" class="form-control" id="rewriteSectionTitle" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">修改指令 (Prompt)</label>
                    <textarea class="form-control" id="rewriteInstruction" rows="4" placeholder="例如：请增加关于2024年市场数据的分析；语气更加客观一点..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="executeRewrite()">确认重写</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="manualEditModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 人工修订</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <input type="hidden" id="manualEditSectionTitle">
                <div class="p-2 bg-warning bg-opacity-10 text-warning small border-bottom">
                    <i class="bi bi-exclamation-triangle"></i> 提示：此处仅编辑【正文内容】，标题请勿在此修改。后台生成仍在继续，请放心修改前文。
                </div>
                <textarea class="form-control border-0 p-3" id="manualEditContent" rows="15" 
                          style="font-family: 'Consolas', monospace; resize: none; font-size: 1rem; line-height: 1.6; outline: none;" 
                          placeholder="加载中..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="saveManualEdit()">
                    <i class="bi bi-check-lg"></i> 保存修改
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../static/utils.js"></script>
<script src="../static/main.js"></script>
</body>
</html>