<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ·±åº¦è®ºæ–‡ç”ŸæˆåŠ©æ‰‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .sidebar { 
            background: white; 
            padding: 25px; 
            border-right: 1px solid #e0e0e0; 
            height: 100vh; 
            overflow-y: auto;       /* è¶…å‡ºéƒ¨åˆ†æ»šåŠ¨ */
            display: block !important; /* âŒ åˆ é™¤ flexï¼Œâœ… æ”¹ä¸º blockï¼Œå½»åº•è§£å†³æŒ¤å‹é—®é¢˜ */
        }
        .output-area { background: white; padding: 40px; min-height: 100vh; overflow-y: auto; position: relative;}
        
        /* æ—¥å¿—åŒºåŸŸæ ·å¼ */
        #logArea { 
            font-size: 0.85rem; 
            background: #212529; 
            color: #00ff9d; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            height: 300px; 
            min-height: 150px;
            max-height: 600px;
            resize: vertical; 
            overflow-y: auto; 
            margin-top: auto; 
            border: 1px solid #444;
            line-height: 1.5;
        }

        /* ç« èŠ‚å¡ç‰‡æ ·å¼ */
        .chapter-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chapter-header {
            background: #f8f9fa;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        .chapter-body {
            padding: 5px;
        }
        .leaf-row {
            display: flex;
            align-items: center;
            padding: 6px 5px;
            border-bottom: 1px dashed #f0f0f0;
        }
        .leaf-row:last-child { border-bottom: none; }
        .leaf-row:hover { background-color: #fcfcfc; }
        
        .leaf-title-input {
            border: none;
            background: transparent;
            font-size: 0.9rem;
            color: #555;
            width: 100%;
            margin-right: 10px;
        }
        .leaf-title-input:focus {
            background: #fff;
            outline: 2px solid #b3d7ff;
            border-radius: 3px;
        }
        
        .word-input-group {
            display: flex;
            align-items: center;
            width: 110px;
            flex-shrink: 0;
        }
        
        textarea { font-size: 0.85rem !important; resize: vertical; }
        .markdown-body h2 { border-left: 5px solid #0d6efd; padding-left: 10px; margin-top: 40px; color: #2c3e50; font-size: 1.6rem;}
        .step-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; }

        .control-bar {
            position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 100;
            padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(5px);
        }

        /* ç™»å½•é®ç½© */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px; width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .history-item {
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.85rem; color: #666;
        }
        .history-item:hover { background: #f8f9fa; color: #0d6efd; }

        /* ä»»åŠ¡åˆ—è¡¨å¡ç‰‡ç¾åŒ– */
        .task-card {
            border: 1px solid #dee2e6 !important;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background: #f8f9fa;
            overflow: hidden;
            margin-bottom: 20px;
            
            /*ä»¥æ­¤ç¡®ä¿å®ƒä¸è¢«å‹ç¼©*/
            flex-shrink: 0 !important; 
            height: auto !important;
            min-height: 150px !important; /* ç»™æ•´ä¸ªå¡ç‰‡ä¸€ä¸ªæœ€å°é«˜åº¦ */
        }

        .task-card-header {
            background: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 20px;
        }

        /* ä»»åŠ¡åˆ—è¡¨é¡¹ */
        .task-item {
            border: none !important;
            border-bottom: 1px solid #f9f9f9 !important;
            padding: 12px 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            padding-left: 20px; /* ä¸ºå·¦ä¾§æŒ‡ç¤ºæ¡ç•™ç©º */
        }

        .task-item:hover {
            background-color: #f8f9fa;
        }

        /* é€‰ä¸­çŠ¶æ€ï¼šå·¦ä¾§è“è‰²æŒ‡ç¤ºæ¡ + æµ…è“èƒŒæ™¯ */
        .task-item.active-task {
            background-color: #f0f7ff !important;
        }

        .task-item.active-task::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #0d6efd; /* Bootstrap Primary Color */
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* åˆ é™¤æŒ‰é’®ï¼šé»˜è®¤éšè—ï¼Œhoveræ˜¾ç¤º */
        .task-delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .task-item:hover .task-delete-btn {
            opacity: 1;
        }

        #taskListContainer {
            min-height: 250px !important;  /* å†…éƒ¨åˆ—è¡¨çš„æœ€å°é«˜åº¦ */
            max-height: 500px !important;
            overflow-y: auto !important;
            display: block !important;
            width: 100% !important;
            background-color: #fff;
            padding-bottom: 10px;
        }

        /* --- 4. æ»šåŠ¨æ¡æ ·å¼ (ä¿æŒä¸å˜) --- */
        #taskListContainer::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }
        #taskListContainer::-webkit-scrollbar-thumb {
            background: #e0e0e0;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h3 class="mb-4 fw-bold text-primary">ğŸ” è®ºæ–‡åŠ©æ‰‹ - ç”¨æˆ·ç™»å½•</h3>
        <p class="text-muted mb-4">è¯·è¾“å…¥ç®¡ç†å‘˜åˆ†å‘çš„å¡å¯† (Key)</p>
        <input type="text" id="userIdInput" class="form-control form-control-lg mb-3" placeholder="ä¾‹å¦‚: key_xxxx">
        <button class="btn btn-primary w-100 btn-lg" id="loginBtn" onclick="handleLogin()">éªŒè¯å¹¶ç™»å½•</button>
        <div class="mt-3 text-muted small"><span id="loginMsg"></span></div>
    </div>
</div>

<div class="container-fluid g-0" id="mainApp" style="filter: blur(5px);">
    <div class="row g-0">
       <div class="col-md-4">
            <div class="sidebar">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold text-primary m-0"><i class="bi bi-gear-fill"></i> è®ºæ–‡é…ç½®</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            ğŸ‘¤ <span id="displayUserId">Guest</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showHistory()">ğŸ“œ å†å²è®°å½•</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()">é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </div>
                </div>

                <div class="card task-card mb-4" style="display: block !important; border: 2px solid #0d6efd !important;">
                    <div class="task-card-header d-flex justify-content-between align-items-center bg-white p-3 border-bottom">
                        <div>
                            <h6 class="m-0 fw-bold text-dark"><i class="bi bi-stack text-primary me-2"></i>å¹¶å‘ä»»åŠ¡</h6>
                            <small class="text-muted" style="font-size: 0.75rem;">ç‚¹å‡»åˆ‡æ¢ä¸åŒè®ºæ–‡</small>
                        </div>
                        <button class="btn btn-primary btn-sm rounded-circle shadow-sm" onclick="createNewTask()" title="æ–°å»ºä»»åŠ¡" style="width: 32px; height: 32px; padding: 0;">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    
                    <div class="list-group list-group-flush" id="taskListContainer" style="max-height: 500px; overflow-y: auto; min-height: 250px; background: #fff;">
                        <div class="text-center text-muted py-3 small">æ­£åœ¨åŠ è½½ä»»åŠ¡...</div>
                    </div>
                </div>
        
                <div class="d-grid gap-2 mb-3">
                    <button type="button" class="btn btn-outline-success fw-bold" onclick="createNewPaper()">
                        <i class="bi bi-plus-circle-fill"></i> âœ¨ æ–°å»ºè®ºæ–‡
                    </button>
                </div>
        
                <form id="paperForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">1</span>è®ºæ–‡é¢˜ç›®</label>
                        <input type="text" class="form-control" id="paperTitle" placeholder="è¾“å…¥è®ºæ–‡é¢˜ç›®" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span><span class="step-badge">2</span>å®Œæ•´å¤§çº² (ç”¨äºè§£æ)</span>
                            <a href="#" class="text-decoration-none small" onclick="loadDemoOutline()">å¡«å…¥ç¤ºä¾‹</a>
                        </label>
                        <textarea class="form-control" id="outlineRaw" rows="6" placeholder="ç²˜è´´å¤§çº²æ–‡æœ¬..." required></textarea>
                        <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-1" onclick="parseOutline()">â¬‡ï¸ 1. è§£æå¤§çº²å¹¶ç”Ÿæˆé…ç½®</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between align-items-center">
                            <span class="step-badge">3</span>ç« èŠ‚ä¸å­—æ•°å¾®è°ƒ
                            <span class="badge bg-light text-dark border">æ€»å­—æ•°: <span id="totalWords">0</span></span>
                        </label>
                        
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text bg-light fw-bold">ç›®æ ‡æ€»å­—æ•°</span>
                            <input type="number" id="globalTotalWords" class="form-control" value="5000" step="500">
                            <button class="btn btn-outline-secondary" type="button" onclick="smartDistributeWords()">ğŸ”„ 2. æ™ºèƒ½åˆ†é…</button>
                        </div>

                        <div id="chapterConfigArea" style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; padding: 5px; border-radius: 4px; background: #fdfdfd;">
                            <div class="text-center text-muted small py-4">è¯·å…ˆç‚¹å‡»ä¸Šæ–¹â€œè§£æå¤§çº²â€æŒ‰é’®...</div>
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-light w-100 mt-1 text-muted border-dashed" style="border:1px dashed #ccc" onclick="addManualChapter()">
                            <i class="bi bi-plus-circle"></i> æ–°å¢ä¸€çº§ç« èŠ‚
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">4</span>å‚è€ƒæ–‡çŒ®</label>
                        <textarea class="form-control" id="references" rows="3" placeholder="ç²˜è´´å‚è€ƒæ–‡çŒ®..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><span class="step-badge">5</span>çœŸå®ç ”ç©¶æ•°æ® (æ”¯æŒä¸Šä¼ )</label>
                        <div class="card p-2 mb-2 bg-light" style="border: 2px dashed #dee2e6;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small text-muted ms-2">æ”¯æŒ .xlsx, .csv, .docx, .pdf, .txt</span>
                                <label class="btn btn-sm btn-outline-primary" for="fileInput" style="cursor: pointer;">
                                    <i class="bi bi-folder-plus"></i> é€‰æ‹©æ–‡ä»¶
                                </label>
                                <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls,.txt,.pdf,.docx" style="display: none;" onchange="handleFileSelect()">
                            </div>
                            <div id="fileListDisplay" class="mt-2 small text-dark ps-2"></div>
                        </div>
                        <textarea class="form-control" id="customData" rows="2" placeholder="åœ¨æ­¤è¡¥å……æ•°æ®çš„æ–‡å­—è¯´æ˜ï¼Œæˆ–ç›´æ¥ç²˜è´´å°æ®µæ–‡æœ¬..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">ğŸš€ 3. å¼€å§‹ç”Ÿæˆ</button>
                </form>
                <div id="logArea" class="mt-3">ç­‰å¾…å°±ç»ª...</div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="output-area">
                <div class="control-bar mb-4">
                    <h4 class="m-0 text-dark">ğŸ“„ ç”Ÿæˆç»“æœé¢„è§ˆ</h4>
                    <div id="controlButtons" style="display: none;">
                        <button class="btn btn-outline-danger btn-sm me-2" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                        <button class="btn btn-warning btn-sm me-2" id="btnPause" onclick="togglePause()">â¸ æš‚åœ</button>
                        <button class="btn btn-danger btn-sm me-2" id="btnStop" onclick="stopTask()">â¹ åœæ­¢</button>
                        <button class="btn btn-success btn-sm me-2" onclick="exportToMarkdown()">ğŸ“¥ å¯¼å‡º MD</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToDocx()">ğŸ“„ å¯¼å‡º Word (Docx)</button>
                    </div>
                </div>
                <div id="resultContent" class="markdown-body">
                    <div class="text-center text-muted mt-5 pt-5">
                        <p style="font-size: 1.2rem;">ğŸ’¡ ç™»å½• -> è§£æå¤§çº² -> æ™ºèƒ½åˆ†é… -> å¼€å§‹ç”Ÿæˆ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“œ å†å²è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="historyList"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ============================================================
    // 0. å…¨å±€çŠ¶æ€ç®¡ç†
    // ============================================================
    let currentUserId = null;
    let taskList = [];          // ä»»åŠ¡å…ƒæ•°æ®åˆ—è¡¨ [{id, title, status, timestamp}]
    let currentTaskId = null;   // å½“å‰èšç„¦çš„ä»»åŠ¡ID
    
    // --- å½“å‰ä»»åŠ¡çš„è¿è¡Œæ—¶çŠ¶æ€ (åˆ‡æ¢ä»»åŠ¡æ—¶ä¼šè‡ªåŠ¨ä¿å­˜/é‡ç½®) ---
    let parsedStructure = []; 
    let fullMarkdownText = "";
    let isPaused = false;
    let abortController = null; // æ§åˆ¶ fetch æµ
    let selectedFiles = [];     // å½“å‰é€‰ä¸­çš„æ–‡ä»¶ (æ³¨æ„ï¼šFileå¯¹è±¡æ— æ³•æŒä¹…åŒ–ï¼Œåˆ‡æ¢ä»»åŠ¡éœ€é‡é€‰)
    let currentEventIndex = 0;  // å½“å‰ä»»åŠ¡çš„æ¶ˆæ¯æ¸¸æ ‡
    
    // ============================================================
    // 1. åˆå§‹åŒ–ä¸é‰´æƒ
    // ============================================================
    window.onload = async function() {
        const storedUser = localStorage.getItem('paper_active_user');
        if (storedUser) {
            await verifyAndLogin(storedUser);
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    };

    async function handleLogin() {
        const inputId = document.getElementById('userIdInput').value.trim();
        const msgSpan = document.getElementById('loginMsg');
        const btn = document.getElementById('loginBtn');
        
        if (!inputId) { 
            msgSpan.innerText = "è¯·è¾“å…¥å¡å¯†"; msgSpan.className = "text-danger"; return; 
        }
        btn.disabled = true; btn.innerText = "éªŒè¯ä¸­...";

        await verifyAndLogin(inputId, btn, msgSpan);
    }

    async function verifyAndLogin(key, btn = null, msgSpan = null) {
        try {
            const res = await fetch('/verify_login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: key })
            });
            const data = await res.json();
            
            if (res.ok) {
                currentUserId = key;
                localStorage.setItem('paper_active_user', key);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.filter = 'none';
                document.getElementById('displayUserId').innerText = key;
                if(msgSpan) { msgSpan.innerText = "ç™»å½•æˆåŠŸï¼"; msgSpan.className = "text-success"; }
                
                // ç™»å½•æˆåŠŸåï¼Œåˆå§‹åŒ–ä»»åŠ¡ç®¡ç†å™¨
                initTaskManager();
            } else {
                if(msgSpan) { 
                    msgSpan.innerText = data.msg || "ç™»å½•å¤±è´¥"; 
                    msgSpan.className = "text-danger";
                }
                if(btn) { btn.disabled = false; btn.innerText = "éªŒè¯å¹¶ç™»å½•"; }
                if(!document.getElementById('userIdInput').value) localStorage.removeItem('paper_active_user');
            }
        } catch(e) { console.error(e); }
    }

    function logout() {
        if(confirm("ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿ")) {
            localStorage.removeItem('paper_active_user');
            location.reload();
        }
    }

    // ============================================================
    // 2. å¤šä»»åŠ¡ç®¡ç†å™¨ (æ ¸å¿ƒé€»è¾‘)
    // ============================================================
    
    function initTaskManager() {
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä»»åŠ¡åˆ—è¡¨
        const stored = localStorage.getItem(`tasks_meta_${currentUserId}`);
        taskList = stored ? JSON.parse(stored) : [];
        
        if (taskList.length === 0) {
            createNewTask(); // æ— ä»»åŠ¡æ—¶è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
        } else {
            // å°è¯•æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„ä»»åŠ¡
            const lastActive = localStorage.getItem(`last_active_id_${currentUserId}`);
            const targetId = taskList.find(t => t.id === lastActive) ? lastActive : taskList[0].id;
            switchTask(targetId);
        }
        renderTaskListUI();
    }

    function createNewTask() {
        // 1. å…ˆä¿å­˜å½“å‰ä»»åŠ¡çŠ¶æ€
        if (currentTaskId) saveCurrentTaskState();

        // 2. åˆ›å»ºæ–°ä»»åŠ¡å¯¹è±¡
        const newTask = {
            id: generateUUID(),
            title: "æ–°è®ºæ–‡ä»»åŠ¡ " + (taskList.length + 1),
            status: 'draft', // draft, running, paused, completed, stopped
            timestamp: Date.now()
        };
        taskList.unshift(newTask); // æ’å…¥åˆ°é¡¶éƒ¨
        saveTaskListMeta();
        
        // 3. åˆ‡æ¢åˆ°æ–°ä»»åŠ¡
        switchTask(newTask.id);
    }

    // åˆ‡æ¢ä»»åŠ¡æ ¸å¿ƒå‡½æ•°ï¼šä¿å­˜æ—§ç°åœº -> æ¸…ç†ç¯å¢ƒ -> åŠ è½½æ–°ç°åœº -> (å¦‚è¿è¡Œä¸­)é‡è¿æµ
    function switchTask(targetId) {
        if (currentTaskId === targetId && document.getElementById('paperTitle').value) return; // é¿å…é‡å¤åˆ‡æ¢

        // A. ç¦»å¼€æ—§ä»»åŠ¡
        if (currentTaskId) {
            saveCurrentTaskState(); // ä¿å­˜ UI æ•°æ®åˆ° localStorage
            if (abortController) {
                abortController.abort(); // æ–­å¼€æ—§ä»»åŠ¡çš„ç›‘å¬è¿æ¥ï¼ˆåå°ä»è¿è¡Œï¼‰
                abortController = null;
            }
        }

        // B. å‡†å¤‡ç¯å¢ƒ
        currentTaskId = targetId;
        localStorage.setItem(`last_active_id_${currentUserId}`, targetId);
        resetWorkspaceVariables(); // æ¸…ç©º JS å˜é‡å’Œ UI è¾“å…¥æ¡†
        
        // C. åŠ è½½æ–°ä»»åŠ¡
        loadTaskState(targetId);
        renderTaskListUI(); // æ›´æ–°åˆ—è¡¨é«˜äº®

        // D. çŠ¶æ€æ¢å¤
        const taskMeta = taskList.find(t => t.id === targetId);
        if (taskMeta) {
            // å¦‚æœä»»åŠ¡æ˜¯è¿è¡Œ/æš‚åœçŠ¶æ€ï¼Œæ¢å¤ UI é”å®šå¹¶é‡è¿
            if (taskMeta.status === 'running' || taskMeta.status === 'paused') {
                lockUI(true);
                // ç«‹å³å‘èµ·é‡è¿ï¼Œä»ä¸Šæ¬¡æ–­å¼€çš„ eventIndex ç»§ç»­æ‹‰å–æ—¥å¿—
                subscribeTask(targetId); 
            } else {
                lockUI(false); // è‰ç¨¿æˆ–å·²å®Œæˆï¼Œè§£é” UI
            }
            // æ›´æ–°æš‚åœæŒ‰é’®çŠ¶æ€
            isPaused = (taskMeta.status === 'paused');
            updatePauseBtnState();
        }
    }

    function deleteTask(e, id) {
        e.stopPropagation(); // é˜»æ­¢è§¦å‘ switchTask
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥ä»»åŠ¡åŠå…¶æ‰€æœ‰å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;

        // æ¸…é™¤å…·ä½“æ•°æ®
        localStorage.removeItem(`draft_${currentUserId}_${id}`);
        // ç§»é™¤å…ƒæ•°æ®
        taskList = taskList.filter(t => t.id !== id);
        saveTaskListMeta();

        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä»»åŠ¡ï¼Œé‡ç½®åˆ°åˆ—è¡¨ç¬¬ä¸€ä¸ªæˆ–æ–°å»º
        if (id === currentTaskId) {
            currentTaskId = null;
            if (abortController) abortController.abort();
            
            if (taskList.length > 0) switchTask(taskList[0].id);
            else createNewTask();
        } else {
            renderTaskListUI();
        }
    }

    // ============================================================
    // 3. çŠ¶æ€æŒä¹…åŒ– (State Persistence)
    // ============================================================

    function saveTaskListMeta() {
        localStorage.setItem(`tasks_meta_${currentUserId}`, JSON.stringify(taskList));
    }

    function saveCurrentTaskState() {
        if (!currentUserId || !currentTaskId) return;

        // æ”¶é›† UI æ•°æ®
        const title = document.getElementById('paperTitle').value;
        const draftData = {
            title: title,
            outline: document.getElementById('outlineRaw').value,
            refs: document.getElementById('references').value,
            customData: document.getElementById('customData').value,
            content: fullMarkdownText,
            structure: parsedStructure,
            eventIndex: currentEventIndex, // [å…³é”®] ä¿å­˜è¿›åº¦æ¸¸æ ‡
            logsHtml: document.getElementById('logArea').innerHTML, // ä¿å­˜æ—¥å¿—ç›˜
            timestamp: Date.now()
        };

        // å†™å…¥ä»»åŠ¡ä¸“å± Key
        localStorage.setItem(`draft_${currentUserId}_${currentTaskId}`, JSON.stringify(draftData));

        // åŒæ­¥æ›´æ–°åˆ—è¡¨ä¸­çš„æ ‡é¢˜
        const taskMeta = taskList.find(t => t.id === currentTaskId);
        if (taskMeta && title) {
            taskMeta.title = title;
            taskMeta.timestamp = Date.now();
            saveTaskListMeta();
        }
    }

    function loadTaskState(id) {
        const json = localStorage.getItem(`draft_${currentUserId}_${id}`);
        if (!json) return; // å¦‚æœæ˜¯çº¯æ–°ä»»åŠ¡ï¼Œä¿æŒé‡ç½®åçš„çŠ¶æ€å³å¯

        const data = JSON.parse(json);
        
        // æ¢å¤ UI è¾“å…¥
        document.getElementById('paperTitle').value = data.title || "";
        document.getElementById('outlineRaw').value = data.outline || "";
        document.getElementById('references').value = data.refs || "";
        document.getElementById('customData').value = data.customData || "";
        
        // æ¢å¤ JS å˜é‡
        parsedStructure = data.structure || [];
        fullMarkdownText = data.content || "";
        currentEventIndex = data.eventIndex || 0;

        // æ¢å¤æ˜¾ç¤º
        if (parsedStructure.length > 0) renderConfigArea();
        if (fullMarkdownText) document.getElementById('resultContent').innerHTML = marked.parse(fullMarkdownText);
        if (data.logsHtml) document.getElementById('logArea').innerHTML = data.logsHtml;
    }

    function resetWorkspaceVariables() {
        // å˜é‡é‡ç½®
        fullMarkdownText = "";
        parsedStructure = [];
        selectedFiles = []; // åˆ‡æ¢ä»»åŠ¡æ—¶æ¸…ç©ºå·²é€‰æ–‡ä»¶ï¼ˆæ— æ³•æŒä¹…åŒ– File å¯¹è±¡ï¼‰
        currentEventIndex = 0;
        isPaused = false;
        
        // UI æ¸…ç©º
        document.getElementById('paperTitle').value = "";
        document.getElementById('outlineRaw').value = "";
        document.getElementById('references').value = "";
        document.getElementById('customData').value = "";
        document.getElementById('fileListDisplay').innerHTML = "";
        document.getElementById('chapterConfigArea').innerHTML = "<div class='text-center text-muted small py-4'>è¯·å…ˆè§£æå¤§çº²...</div>";
        document.getElementById('logArea').innerHTML = "å‡†å¤‡å°±ç»ª...";
        document.getElementById('resultContent').innerHTML = "<div class='text-center text-muted mt-5 pt-5'><p style='font-size: 1.2rem;'>ğŸ’¡ ç™»å½• -> è§£æå¤§çº² -> æ™ºèƒ½åˆ†é… -> å¼€å§‹ç”Ÿæˆ</p></div>";
        document.getElementById('totalWords').innerText = "0";
    }

    // ============================================================
    // 4. æäº¤ä¸æ‰§è¡Œé€»è¾‘
    // ============================================================

    document.getElementById('paperForm').onsubmit = async (e) => {
        e.preventDefault();
        
        if (parsedStructure.length === 0) {
            alert("è¯·å…ˆè§£æå¤§çº²ï¼");
            return;
        }

        // 1. æ›´æ–°ä»»åŠ¡å…ƒæ•°æ®çŠ¶æ€
        const taskMeta = taskList.find(t => t.id === currentTaskId);
        if (!taskMeta) return;
        taskMeta.status = 'running';
        taskMeta.title = document.getElementById('paperTitle').value || "æœªå‘½åä»»åŠ¡";
        saveTaskListMeta();
        renderTaskListUI();

        // 2. å‡†å¤‡å¯åŠ¨
        if (abortController) abortController.abort();
        abortController = new AbortController();
        currentEventIndex = 0; // æ–°ç”Ÿæˆå¼€å§‹ï¼Œæ¸¸æ ‡å½’é›¶
        isPaused = false;
        
        // 3. æ„å»ºå‘é€æ•°æ®
        const flatTasks = [];
        parsedStructure.forEach(group => {
            flatTasks.push({ title: group.title, is_parent: true, level: 1, words: 0 });
            group.children.forEach(child => {
                flatTasks.push({ 
                    title: child.text, is_parent: false, words: child.words || 0, 
                    use_data: child.useData, level: child.level || 2 
                });
            });
        });

        // é”å®š UI å¹¶ä¿å­˜åˆå§‹çŠ¶æ€
        lockUI(true);
        saveCurrentTaskState();

        const formData = new FormData();
        formData.append('title', taskMeta.title);
        formData.append('references', document.getElementById('references').value);
        formData.append('custom_data', document.getElementById('customData').value);
        selectedFiles.forEach(file => { formData.append('data_files', file); });
        formData.append('chapter_data', JSON.stringify(flatTasks));
        formData.append('task_id', currentTaskId);
        
        // å¦‚æœæœ‰å†…å®¹ï¼Œè§†ä¸ºæ–­ç‚¹ç»­ä¼ ï¼ˆContextï¼‰
        if (fullMarkdownText && fullMarkdownText.length > 50) {
             formData.append('initial_context', fullMarkdownText.slice(-3000));
        }

        try {
            // 4. å‘é€å¯åŠ¨æŒ‡ä»¤ (POST)
            const response = await authenticatedFetch('/generate', { 
                method: 'POST', body: formData 
            });
            
            if (response.ok) {
                appendLog("âœ… ä»»åŠ¡å·²åœ¨åå°å¯åŠ¨ï¼Œæ­£åœ¨å»ºç«‹è¿æ¥...", 'info');
                // 5. å¯åŠ¨æˆåŠŸï¼Œå¼€å§‹ç›‘å¬
                subscribeTask(currentTaskId);
            } else {
                const errJson = await response.json();
                throw new Error(errJson.msg || "æœåŠ¡å™¨å¯åŠ¨ä»»åŠ¡å¤±è´¥");
            }
        } catch (err) {
            appendLog("âŒ å¯åŠ¨å¼‚å¸¸: " + err, 'error');
            taskMeta.status = 'stopped';
            saveTaskListMeta();
            renderTaskListUI();
            lockUI(false);
        }
    };

    // ============================================================
    // 5. è¿›åº¦æµç›‘å¬ (SSE Long-Polling)
    // ============================================================

    async function subscribeTask(taskId) {
        // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢åˆ‡æ¢ä»»åŠ¡åï¼Œæ—§ä»»åŠ¡çš„ç›‘å¬å™¨è¿˜åœ¨è·‘
        if (taskId !== currentTaskId) return;

        if (abortController) abortController.abort();
        abortController = new AbortController();

        try {
            // è¯·æ±‚æµï¼šæºå¸¦ task_id å’Œ last_index (å®ç°å¹¶å‘ä¸æ–­ç‚¹ç»­ä¼ çš„å…³é”®)
            const response = await authenticatedFetch(`/stream_progress?task_id=${taskId}&last_index=${currentEventIndex}`, {
                method: 'GET',
                signal: abortController.signal
            });

            if (!response.ok) throw new Error("è¿æ¥æµå¤±è´¥");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop(); 

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(trimmed.replace('data: ', ''));
                            
                            // [æ ¸å¿ƒ] æ¸¸æ ‡è‡ªå¢ï¼Œä¿å­˜è¿›åº¦
                            currentEventIndex++; 

                            if (data.type === 'log') {
                                appendLog(data.msg); 
                            } else if (data.type === 'content') {
                                fullMarkdownText += data.md;
                                document.getElementById('resultContent').innerHTML = marked.parse(fullMarkdownText);
                                saveCurrentTaskState(); // å®æ—¶ä¿å­˜
                            } else if (data.type === 'done') {
                                finishTask(taskId);
                                return;
                            }
                        } catch (e) { console.error(e); }
                    }
                }
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                // å¦‚æœå½“å‰ä»»åŠ¡ä»æ˜¯è¿™ä¸ªIDï¼Œè¯´æ˜æ˜¯æ„å¤–æ–­å¼€ï¼Œå°è¯•é‡è¿
                if (currentTaskId === taskId) {
                    appendLog("âš ï¸ ç½‘ç»œæ³¢åŠ¨ï¼Œ3ç§’åå°è¯•é‡è¿...", 'warn');
                    setTimeout(() => subscribeTask(taskId), 3000);
                }
            }
        }
    }

    function finishTask(taskId) {
        if (taskId !== currentTaskId) return;
        
        lockUI(false);
        appendLog("ğŸ‰ ç”Ÿæˆå®Œæˆï¼", 'info');
        
        const task = taskList.find(t => t.id === taskId);
        if (task) { task.status = 'completed'; saveTaskListMeta(); renderTaskListUI(); }
        saveCurrentTaskState();
        alert("å½“å‰ä»»åŠ¡ç”Ÿæˆå®Œæˆï¼");
    }

    // ============================================================
    // 6. UI è¾…åŠ©å‡½æ•°
    // ============================================================

    function renderTaskListUI() {
        const container = document.getElementById('taskListContainer');
        container.innerHTML = "";
        
        if (taskList.length === 0) {
            container.innerHTML = "<div class='text-center text-muted py-3 small'>æš‚æ— ä»»åŠ¡</div>";
            return;
        }

        taskList.forEach(task => {
            const isActive = task.id === currentTaskId;
            
            // çŠ¶æ€é…ç½®
            const statusConfig = {
                'draft':     { icon: 'bi-pencil-square', color: 'text-secondary', text: 'è‰ç¨¿' },
                'running':   { icon: 'spinner-grow spinner-grow-sm', color: 'text-success', text: 'ç”Ÿæˆä¸­...' },
                'paused':    { icon: 'bi-pause-circle-fill', color: 'text-warning', text: 'å·²æš‚åœ' },
                'completed': { icon: 'bi-check-circle-fill', color: 'text-primary', text: 'å·²å®Œæˆ' },
                'stopped':   { icon: 'bi-stop-circle-fill', color: 'text-danger', text: 'å·²åœæ­¢' }
            };
            
            const st = statusConfig[task.status] || statusConfig['draft'];
            // å¤„ç† icon: å¦‚æœåŒ…å« spinner ç±»ååˆ™ç›´æ¥ä½œä¸º classï¼Œå¦åˆ™åŠ ä¸Š bi å‰ç¼€
            const iconHtml = st.icon.includes('spinner') 
                ? `<span class="${st.icon}" role="status" aria-hidden="true"></span>` 
                : `<i class="bi ${st.icon}"></i>`;

            const btn = document.createElement('div');
            // æ³¨æ„è¿™é‡Œä½¿ç”¨äº†æ–°çš„ç±»å active-task å’Œ task-item
            btn.className = `list-group-item task-item d-flex justify-content-between align-items-center ${isActive ? 'active-task' : ''}`;
            btn.onclick = () => switchTask(task.id);
            
            // æ ¼å¼åŒ–æ—¶é—´ï¼šå¦‚æœæ˜¯ä»Šå¤©æ˜¾ç¤ºçš„â€œæ—¶:åˆ†â€ï¼Œå¦åˆ™æ˜¾ç¤ºâ€œæœˆ-æ—¥â€
            const date = new Date(task.timestamp);
            const isToday = new Date().toDateString() === date.toDateString();
            const timeStr = isToday ? date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : date.toLocaleDateString([], {month: 'numeric', day: 'numeric'});

            btn.innerHTML = `
                <div class="d-flex flex-column text-truncate" style="width: 85%;">
                    <div class="fw-bold text-dark text-truncate mb-1" style="font-size: 0.9rem;">
                        ${task.title || 'æœªå‘½åä»»åŠ¡'}
                    </div>
                    <div class="d-flex align-items-center small">
                        <span class="${st.color} me-2 d-flex align-items-center" style="font-size: 0.75rem;">
                            ${iconHtml} <span class="ms-1">${st.text}</span>
                        </span>
                        <span class="text-muted" style="font-size: 0.75rem;">${timeStr}</span>
                    </div>
                </div>
                <button onclick="deleteTask(event, '${task.id}')" class="btn btn-sm btn-link text-danger p-0 task-delete-btn" title="åˆ é™¤">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(btn);
        });
    }

    function lockUI(locked) {
        document.getElementById('btnSubmit').disabled = locked;
        document.getElementById('controlButtons').style.display = locked ? 'block' : 'none';
        
        // ç¦ç”¨/å¯ç”¨è¾“å…¥æ¡†
        const inputs = ['paperTitle', 'outlineRaw', 'references', 'customData', 'globalTotalWords', 'fileInput'];
        inputs.forEach(id => { const el = document.getElementById(id); if(el) el.disabled = locked; });
        document.querySelectorAll('.chapter-card input, .chapter-card button').forEach(el => el.disabled = locked);

        // æ§åˆ¶æ¡çŠ¶æ€
        if (!locked) {
            // å®ŒæˆçŠ¶æ€ï¼šæ˜¾ç¤ºå¯¼å‡ºï¼Œéšè—æ§åˆ¶
            document.getElementById('controlButtons').style.display = 'block';
            document.getElementById('btnPause').style.display = 'none';
            document.getElementById('btnStop').style.display = 'none';
        } else {
            // è¿è¡ŒçŠ¶æ€ï¼šæ˜¾ç¤ºæ§åˆ¶
            document.getElementById('btnPause').style.display = 'inline-block';
            document.getElementById('btnStop').style.display = 'inline-block';
        }
    }

    function updatePauseBtnState() {
        const btn = document.getElementById('btnPause');
        btn.innerText = isPaused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
        btn.className = isPaused ? "btn btn-info btn-sm me-2" : "btn btn-warning btn-sm me-2";
    }

    // --- æ§åˆ¶æ“ä½œ ---
    async function togglePause() { 
        const action = isPaused ? 'resume' : 'pause';
        await authenticatedFetch('/control', {method: 'POST', body: JSON.stringify({ task_id: currentTaskId, action: action })});
        
        // æœ¬åœ°çŠ¶æ€æ›´æ–°
        isPaused = !isPaused;
        const task = taskList.find(t => t.id === currentTaskId);
        if(task) { task.status = isPaused ? 'paused' : 'running'; saveTaskListMeta(); renderTaskListUI(); }
        updatePauseBtnState();
        appendLog(isPaused ? "â¸ ä»»åŠ¡å·²æš‚åœ" : "â–¶ ä»»åŠ¡ç»§ç»­", 'warn');
    }
    
    async function stopTask() { 
        if(!confirm("ç¡®å®šåœæ­¢å½“å‰ä»»åŠ¡ï¼Ÿ")) return;
        if(abortController) abortController.abort();
        
        await authenticatedFetch('/control', {method: 'POST', body: JSON.stringify({ task_id: currentTaskId, action: 'stop' })});
        
        const task = taskList.find(t => t.id === currentTaskId);
        if(task) { task.status = 'stopped'; saveTaskListMeta(); renderTaskListUI(); }
        
        lockUI(false);
        appendLog("â¹ ä»»åŠ¡å·²æ‰‹åŠ¨åœæ­¢", 'error');
        saveCurrentTaskState();
    }

    function createNewPaper() {
        if(confirm("æ–°å»ºè®ºæ–‡å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å¹¶å‘ä»»åŠ¡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) {
            createNewTask();
        }
    }

    function clearResults(silent = false) {
        if (!silent && !confirm("ç¡®å®šæ¸…ç©ºæ­£æ–‡å†…å®¹å—ï¼Ÿ(é…ç½®ä¿ç•™)")) return;
        fullMarkdownText = "";
        document.getElementById('resultContent').innerHTML = "<div class='text-center text-muted mt-5 pt-5'><p style='font-size: 1.2rem;'>ğŸ’¡ å†…å®¹å·²æ¸…ç©º</p></div>";
        currentEventIndex = 0; // é‡ç½®æ¸¸æ ‡
        // çŠ¶æ€é‡ç½®ä¸º draft
        const task = taskList.find(t => t.id === currentTaskId);
        if(task) { task.status = 'draft'; saveTaskListMeta(); renderTaskListUI(); }
        
        lockUI(false);
        saveCurrentTaskState();
        if(!silent) appendLog("ğŸ—‘ï¸ å†…å®¹å·²æ¸…ç©º", 'warn');
    }

    // --- åŸºç¡€å·¥å…·å‡½æ•° ---
    async function authenticatedFetch(url, options = {}) {
        if (!options.headers) options.headers = {};
        if (!(options.body instanceof FormData)) options.headers['Content-Type'] = 'application/json';
        options.headers['X-User-ID'] = currentUserId;
        return fetch(url, options);
    }

    function appendLog(msg, type = 'info') {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        let color = '#00ff9d';
        if (type === 'error') color = '#ff4d4d';
        if (type === 'warn') color = '#ffc107';
        
        const html = `<div style="color:${color}; border-bottom:1px dashed #333; padding:2px 0;">[${time}] ${msg}</div>`;
        logArea.innerHTML += html;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c === 'x' ? Math.random() * 16 | 0 : (Math.random() * 16 | 0) & 0x3 | 0x8).toString(16)); }
    function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    // --- æ–‡ä»¶ä¸å¯¼å‡º ---
    function handleFileSelect() {
        const input = document.getElementById('fileInput');
        selectedFiles = selectedFiles.concat(Array.from(input.files));
        renderFileList();
        input.value = ''; 
    }
    function renderFileList() {
        const list = document.getElementById('fileListDisplay');
        list.innerHTML = selectedFiles.map((f, i) => `
            <div class='d-flex justify-content-between border-bottom py-1'>
                <span class='text-truncate small'>ğŸ“„ ${f.name}</span>
                <button class='btn btn-link text-danger p-0' onclick='removeFile(${i})'>Ã—</button>
            </div>`).join('');
    }
    function removeFile(i) { selectedFiles.splice(i, 1); renderFileList(); }

    function exportToMarkdown() {
        if(!fullMarkdownText) return;
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([fullMarkdownText], {type: 'text/markdown'}));
        a.download = `${document.getElementById('paperTitle').value || 'thesis'}.md`; a.click();
    }
    async function exportToDocx() {
        if(!fullMarkdownText) return alert("æ— å†…å®¹");
        try {
            const res = await authenticatedFetch('/export_docx', { method: 'POST', body: JSON.stringify({ content: fullMarkdownText }) });
            if (res.ok) {
                const url = window.URL.createObjectURL(await res.blob());
                const a = document.createElement('a'); a.href = url; a.download = `${document.getElementById('paperTitle').value || 'thesis'}.docx`; a.click();
            }
        } catch(e) { alert("å¯¼å‡ºå¤±è´¥"); }
    }

    // ============================================================
    // 7. å¤§çº²è§£æä¸é…ç½®é€»è¾‘ (ä¿ç•™åŸæœ‰é€»è¾‘)
    // ============================================================
    
    function loadDemoOutline() {
        document.getElementById('outlineRaw').value = `æ‘˜è¦\nç¬¬ä¸€ç«  ç»ªè®º\n1.1 ç ”ç©¶èƒŒæ™¯\n1.2 ç ”ç©¶æ„ä¹‰\nç¬¬äºŒç«  æ ¸å¿ƒç†è®º\n2.1 ç†è®ºåŸºç¡€\nç¬¬ä¸‰ç«  æ€»ç»“\nå‚è€ƒæ–‡çŒ®`;
        parseOutline();
    }

    function analyzeLineStructure(text) {
        text = text.trim();
        if (!text) return null;
        if (/^(æ‘˜è¦|Abstract|å‚è€ƒæ–‡çŒ®|è‡´è°¢|æ€»ç»“|ç»“è®º)/i.test(text)) return { level: 1, type: 'keyword' };
        if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+[ç« |éƒ¨åˆ†]/.test(text)) return { level: 1, type: 'chapter' };
        const decimalMatch = text.match(/^(\d+(\.\d+)+)/);
        if (decimalMatch) return { level: decimalMatch[1].split('.').length, type: 'decimal' };
        if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/.test(text)) return { level: 2, type: 'cn_num' };
        if (/^[\(ï¼ˆ][ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+[\)ï¼‰]/.test(text)) return { level: 3, type: 'paren' };
        if (/^\d+([\.\sã€]|$)/.test(text)) return { level: 1, type: 'simple_num' };
        return { level: 2, type: 'text' }; 
    }

    function parseOutline() {
        const text = document.getElementById('outlineRaw').value;
        const lines = text.split('\n');
        let processedItems = [];
        let lastLevel1Type = null; 

        lines.forEach(line => {
            const trimmed = line.trim();
            if(!trimmed) return;
            let info = analyzeLineStructure(trimmed);
            if (info.type === 'simple_num' && lastLevel1Type === 'chapter') info.level = 2;
            if (info.level === 1) lastLevel1Type = info.type;

            processedItems.push({
                text: trimmed, level: info.level, isParent: false, words: 0,
                useData: /ç»“æœ|åˆ†æ|å®éªŒ|æ•°æ®|éªŒè¯|æµ‹è¯•/.test(trimmed)
            });
        });

        for (let i = 0; i < processedItems.length - 1; i++) {
            if (processedItems[i+1].level > processedItems[i].level) processedItems[i].isParent = true;
        }

        parsedStructure = [];
        let currentMainGroup = null;
        processedItems.forEach(item => {
            if (item.level === 1) {
                currentMainGroup = { title: item.text, children: [] };
                parsedStructure.push(currentMainGroup);
                if (!item.isParent) currentMainGroup.children.push(item);
            } else {
                if (!currentMainGroup) {
                    currentMainGroup = { title: "å‰è¨€/å¯¼è®º", children: [] };
                    parsedStructure.push(currentMainGroup);
                }
                currentMainGroup.children.push(item);
            }
        });
        smartDistributeWords();
    }

    function smartDistributeWords() {
        const totalTarget = parseInt(document.getElementById('globalTotalWords').value) || 5000;
        let reserved = 0, activeLeaves = [];
        parsedStructure.forEach(group => {
            group.children.forEach(child => {
                if (child.isParent) return; 
                if (/æ‘˜è¦|Abstract/.test(child.text)) { child.words = 400; reserved += 400; }
                else if (/å‚è€ƒæ–‡çŒ®|è‡´è°¢/.test(child.text)) child.words = 0;
                else activeLeaves.push(child);
            });
        });
        let avgWords = Math.max(200, Math.round(Math.floor(Math.max(0, totalTarget - reserved) / (activeLeaves.length || 1)) / 50) * 50);
        activeLeaves.forEach(leaf => leaf.words = avgWords);
        renderConfigArea();
    }

    function renderConfigArea() {
        const container = document.getElementById('chapterConfigArea');
        container.innerHTML = '';
        let globalTotal = 0;

        parsedStructure.forEach((group, gIdx) => {
            let chapterTotalWords = 0;
            group.children.forEach(c => chapterTotalWords += (c.words || 0));
            globalTotal += chapterTotalWords;

            const card = document.createElement('div');
            card.className = 'chapter-card';
            card.innerHTML = `
                <div class="chapter-header py-2">
                    <div class="d-flex align-items-center" style="width: 35%;">
                        <i class="bi bi-folder2-open me-2 text-primary"></i> 
                        <span class="text-truncate fw-bold" title="${group.title}">${group.title}</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-center" style="width: 40%;">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white text-muted">æœ¬ç« </span>
                            <input type="number" class="form-control text-center" id="chapter-total-${gIdx}" value="${chapterTotalWords}" step="100" min="0">
                            <button class="btn btn-outline-secondary" type="button" onclick="distributeChapterWords(${gIdx})"><i class="bi bi-arrow-down-up"></i> åˆ†é…</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-end" style="width: 25%;">
                        <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="sortLeaves(${gIdx})"><i class="bi bi-sort-numeric-down"></i></button>
                        <button class="btn btn-sm btn-link text-success p-0 me-2" onclick="addLeaf(${gIdx})"><i class="bi bi-plus-circle"></i></button>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteGroup(${gIdx})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <div class="chapter-body"></div>
            `;
            
            const body = card.querySelector('.chapter-body');
            group.children.forEach((child, cIdx) => {
                const row = document.createElement('div');
                row.className = 'leaf-row';
                const indent = Math.max(0, (child.level - 2) * 20); 
                const dataBtnColor = child.useData ? 'btn-outline-success active' : 'btn-outline-secondary';
                
                row.innerHTML = `
                    <div class="d-flex align-items-center flex-grow-1" style="padding-left: ${indent}px;">
                        ${child.level > 2 ? '<i class="bi bi-arrow-return-right text-muted me-2 small"></i>' : ''}
                        <input type="text" class="leaf-title-input" value="${child.text}" onchange="updateLeaf(${gIdx}, ${cIdx}, 'text', this.value)">
                    </div>
                    <div class="me-2">
                        <button type="button" class="btn btn-sm ${dataBtnColor}" onclick="toggleLeafData(${gIdx}, ${cIdx})" title="æ•°æ®æŒ‚è½½å¼€å…³" style="font-size: 0.75rem; padding: 2px 6px;">
                            <i class="bi bi-database${child.useData ? '-fill-check' : ''}"></i> æ•°æ®
                        </button>
                    </div>
                    <div class="word-input-group">
                        <input type="number" class="form-control form-control-sm word-input" value="${child.words}" step="50" min="0" onchange="updateLeaf(${gIdx}, ${cIdx}, 'words', this.value)">
                        <span class="ms-1 small text-muted">å­—</span>
                    </div>
                    <button class="btn btn-sm text-secondary ms-2" onclick="deleteLeaf(${gIdx}, ${cIdx})"><i class="bi bi-x"></i></button>
                `;
                body.appendChild(row);
            });
            container.appendChild(card);
        });
        document.getElementById('totalWords').innerText = globalTotal;
    }

    function distributeChapterWords(gIdx) {
        const targetTotal = parseInt(document.getElementById(`chapter-total-${gIdx}`).value) || 0;
        const group = parsedStructure[gIdx];
        const activeLeaves = group.children.filter(c => !c.isParent);
        if (activeLeaves.length === 0) return alert("è¯¥ç« èŠ‚ä¸‹æ²¡æœ‰å¯åˆ†é…çš„å°èŠ‚");
        
        let avg = Math.floor(targetTotal / activeLeaves.length);
        if (targetTotal > 0) avg = Math.max(50, Math.round(avg / 50) * 50);
        else avg = 0;
        
        activeLeaves.forEach(leaf => leaf.words = avg);
        renderConfigArea();
    }

    function updateLeaf(gIdx, cIdx, field, value) {
        if (field === 'words') value = parseInt(value) || 0;
        parsedStructure[gIdx].children[cIdx][field] = value;
        if (field === 'words') renderConfigArea(); // Update total words
        if (field === 'text') sortLeaves(gIdx);
    }

    function toggleLeafData(gIdx, cIdx) {
        parsedStructure[gIdx].children[cIdx].useData = !parsedStructure[gIdx].children[cIdx].useData;
        renderConfigArea();
    }

    function sortLeaves(gIdx) {
        const group = parsedStructure[gIdx];
        const leaves = group.children.filter(c => !c.isParent);
        const parents = group.children.filter(c => c.isParent);
        leaves.sort((a, b) => {
            const getVer = s => (s.match(/^(\d+(\.\d+)*)/) || ['999'])[0].split('.').map(Number);
            const vA = getVer(a.text), vB = getVer(b.text);
            for(let i=0; i<Math.max(vA.length, vB.length); i++) {
                if ((vA[i]||0) !== (vB[i]||0)) return (vA[i]||0) - (vB[i]||0);
            }
            return 0;
        });
        group.children = [...parents, ...leaves];
        renderConfigArea();
    }

    function deleteLeaf(gIdx, cIdx) { parsedStructure[gIdx].children.splice(cIdx, 1); renderConfigArea(); }
    function addLeaf(gIdx) {
        const title = prompt("è¯·è¾“å…¥æ–°å°èŠ‚æ ‡é¢˜");
        if (title) { parsedStructure[gIdx].children.push({ text: title, isParent: false, words: 500 }); sortLeaves(gIdx); }
    }
    function deleteGroup(gIdx) { if(confirm("ç¡®å®šåˆ é™¤è¯¥ç« èŠ‚ï¼Ÿ")) { parsedStructure.splice(gIdx, 1); renderConfigArea(); } }
    function addManualChapter() {
        const title = prompt("è¯·è¾“å…¥æ–°ç« èŠ‚æ ‡é¢˜");
        if(title) { parsedStructure.push({ title: title, children: [{ text: title + " æ¦‚è¿°", isParent: false, words: 500 }] }); renderConfigArea(); }
    }
</script>
</body>
</html>